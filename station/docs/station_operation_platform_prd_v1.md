# **产品需求文档 (PRD)：充电站运营平台 V1.0**

**版本：1.0**
**日期：2025-07-22**

## 1. 产品概述

### 1.1 产品定位
充电站运营平台是整个智能充电服务网络的核心后台管理系统。它作为连接物理充电设施（充电桩）与上层业务应用（用户App、计费系统、订单系统）的枢纽，负责所有充电资产的生命周期管理、实时状态监控、计费策略维护和远程运营控制。

**V1.0 版本定位：** 专注于构建平台的**核心数据底座和后端服务能力**，打通与充电桩网关的数据链路，为上层业务的快速迭代提供稳定、可靠的资产数据、计费规则和控制接口。



### 1.3 核心价值主张
*   **数据实时性与一致性：** 确保平台显示的充电桩状态与物理世界的实际状态保持高度同步和一致。
*   **资产数字化管理：** 将线下分散的充电资产（站、桩）进行集中的数字化管理，提升信息管理效率。
*   **能力服务化：** 将资产管理、定价和远程控制能力通过标准API对外提供，解耦底层硬件与上层业务，加速业务创新。

## 2. 需求分析

### 2.1 业务流程与数据流分析

为了精确定义本平台的需求，我们必须首先深入理解充电桩在一次完整业务周期中的数据流动和状态变迁。

#### 2.1.1 核心数据链路分析

根据《高可用充电桩网关 - Kubernetes 原生架构设计》，本平台在数据链路中扮演着承上启下的关键角色：

*   **上行数据流 (感知层):**
    *   **路径:** `充电桩` -> `网关Pod` -> `Kafka Topic: ocpp-events-up` -> `本平台`
    *   **职责:** 本平台作为Kafka消费者，必须订阅 `ocpp-events-up` 主题。实时消费网关发布的标准化业务事件（如 `DeviceOnlineEvent`, `StatusNotificationEvent`, `MeterValuesEvent`），并将其转化为平台内部的数据状态更新。这是平台感知物理世界变化的核心。

*   **下行数据流 (控制层):**
    *   **路径:** `其他服务 (如订单服务)` -> `本平台API` -> `本平台` -> `Kafka Topic: commands-down` -> `网关Pod` -> `充电桩`
    *   **职责:** 本平台需提供标准的内部API（如启动/停止充电）。当接收到API调用时，平台必须遵循网关的路由协议：查询Redis获取目标桩所在的Pod ID，计算出Kafka分区，然后将标准化的指令发布到 `commands-down` 主题的指定分区。这是平台控制物理设备的核心。




## 3. 功能规格

### 3.1 核心功能 (P0)

#### **功能名称：充电资产信息管理 (Asset Management)**
*   **功能描述：** 提供一套完整的RESTful API，用于对充电站和充电桩进行增、删、改、查（CRUD）操作。
*   **API端点:**
    *   `POST /api/v1/stations`: 创建充电站。
    *   `GET /api/v1/stations`: 查询充电站列表。
    *   `POST /api/v1/stations/{stationId}/piles`: 创建充电桩。
    *   `GET /api/v1/piles/{pileId}`: 查询充电桩详情。
*   **验收标准：**
    *   创建充电桩时，`chargePointId` (物理设备SN) 字段必须唯一，否则返回 `Conflict`。
    *   查询充电桩详情时，返回信息必须包含静态属性（型号、功率）和动态状态（`status`, `lastHeartbeatAt`）。

#### **功能名称：上行数据处理与状态同步 (Upstream Data Processing & Status Sync)**
*   **功能描述：** 实现核心的Kafka消费逻辑，实时处理网关上报的事件，并更新数据库。
*   **验收标准：**
    *   平台必须能够正确解析网关定义的所有统一业务事件。
    *   从Kafka消息产生到数据库状态更新完成，P95延迟应在2秒以内。
    *   消费者服务必须具备幂等性，重复消费同一消息不能导致数据状态错误。

#### **功能名称：下行指令服务 (Downstream Command Service)**
*   **功能描述：** 对内部其他服务（如订单服务）提供统一的、简化的API，用于向充电桩下发指令。
*   **API端点:**
    *   `POST /api/v1/piles/{pileId}/commands/start-transaction`: 启动充电。
    *   `POST /api/v1/piles/{pileId}/commands/stop-transaction`: 停止充电。
    *   `POST /api/v1/piles/{pileId}/commands/reset`: 重启充电桩。
*   **交互流程 (以启动充电为例):**
    1.  订单服务调用 `POST /api/v1/piles/{pileId}/commands/start-transaction`。
    2.  本平台接收到请求，首先校验桩的状态是否为 `Available`。
    3.  查询Redis获取 `conn:{pileId}` 对应的 `gateway-pod-xyz`。
    4.  构造符合OCPP规范的 `RemoteStartTransaction` 指令。
    5.  计算分区 `hash("gateway-pod-xyz") % 128`。
    6.  将指令发布到 `commands-down` 主题的指定分区。
    7.  (可选，V1.1) 异步等待网关通过Kafka上报的指令执行结果，更新指令状态。
*   **验收标准：**
    *   API必须能正确处理设备离线或状态不符（如对一个正在充电的桩下发启动指令）时的错误情况，返回明确的错误码。
    *   API必须完整实现“查Redis->算分区->发Kafka”的流程。
    *   API必须是异步的，调用后应立即返回“指令已接收”状态，而不是等待指令执行完毕。

