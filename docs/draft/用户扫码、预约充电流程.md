好的，我们来设计 **用户扫码充电流程** 和 **用户预约充电流程**。

由于 Mermaid 流程图的特性，更适合表达清晰的步骤和决策路径。对于更复杂、涉及多系统交互的流程，通常会拆分为几个子流程或使用 BPMN 等更专业的工具。这里我将力求清晰地展示核心逻辑。

---

## 1. 用户扫码充电流程 (Mermaid Flowchart)

这个流程图将涵盖用户从打开 App 到完成充电支付的主要步骤。

```mermaid
graph TD
    %% --- 准备阶段 ---
    A[用户打开App] --> B{是否已登录?}
    B -- 否 --> C[前往登录/注册]
    C --> B
    B -- 是 --> D[进入地图/充电入口]

    %% --- 扫码与验证 ---
    D --> E[选择“扫码充电”入口]
    E --> F[App启动扫码功能]
    F -- 扫描成功 --> G{App检查本地网络}
    G -- 网络正常 --> H[App发送请求: 识别充电桩信息]
    G -- 网络异常 --> G_Fail[App提示: 网络异常,请检查]
    G_Fail --> D
    
    H --> I{平台验证桩信息 & 获取实时状态}
    I -- 验证成功 & 空闲 --> J[App显示充电桩详情页: 功率, 费率, 状态]
    I -- 验证失败/非空闲 --> I_Fail[App提示: 桩不可用或信息错误]
    I_Fail --> D

    %% --- 启动与预授权 (关键修改) ---
    J --> K[用户确认并点击“启动充电”]
    %% -- 增加预授权/余额检查
    K --> K_PreAuth{平台预授权/余额检查} 
    K_PreAuth -- 检查通过 --> L[App发送请求: 启动充电]
    K_PreAuth -- 检查失败 --> K_Fail[App提示: 余额不足/授权失败, 并引导充值/绑卡]
    K_Fail --> J

    %% --- 平台处理与状态机 (关键修改) ---
    %% -- 明确初始状态
    L --> M[平台创建订单: 状态'启动中'] 
    M --> N{平台下发指令给桩 & 等待桩响应}
    N -- 桩成功响应 & 开始充电 --> O[平台更新订单状态: '充电中']
    N -- 桩响应失败/超时 --> N_Fail[平台更新订单状态: '启动失败']
    N_Fail --> O_Fail[App提示: 启动失败,请重试或联系客服]
    O_Fail --> D
    
    O --> P[App显示充电中界面: 实时电量, 费用, 时长]

    %% --- 充电结束 (关键修改) ---
    P --> R{充电结束方式?}
    R -- 1. 用户App手动停止 --> S[App发送请求: 停止充电]
    R -- 2. 达到设定值自动停 --> S_Auto[充电桩自动结束]
    %% <-- 增加车机端停止
    R -- 3. 车机端/车辆BMS停止 --> S_Car[充电桩上报: 本地停止] 
    %% <-- 修正异常路径
    R -- 4. 充电桩异常/枪被拔 --> S_Error[充电桩上报: 异常中断] 

    %% --- 结算与支付 ---
    S --> T((充电结束))
    S_Auto --> T
    S_Car --> T
    S_Error --> T
    
    T --> U[平台计算最终费用 & 更新订单状态: '待支付']
    U --> V[App显示充电总结界面: 总电量, 总费用, 时长]
    V --> W{用户确认支付}
    W -- 支付成功 --> X[平台更新订单状态: '已支付']
    X --> Y[App显示“支付成功”, 服务完成]

    %% --- 支付异常处理 (关键修改) ---
    W -- 支付失败 --> W_Fail[App提示: 支付失败, 请重试]
    W_Fail --> V
    %% <-- 明确后续状态
    W -- 用户稍后支付/关闭App --> Z[订单保持'待支付'状态] 
    Z --> Z_Notify[平台后续通过消息/短信提醒用户支付]


```

### 流程解释：
1.  **准备阶段：** 用户打开App并登录。
2.  **扫码启动：** 用户通过App扫码，App将扫码结果发送给平台，平台验证桩信息并获取实时状态。
3.  **启动确认：** App显示桩详情，用户确认后点击启动，平台发送启动指令给充电桩。
4.  **充电进行中：** 充电成功启动后，App实时显示充电状态。
5.  **充电结束：** 充电可由多种方式（自动、手动、异常）结束。
6.  **费用结算与支付：** 平台计算最终费用，用户在App中完成支付。

---

## 2. 用户预约充电流程 (Mermaid Flowchart)

这个流程图将涵盖用户从搜索到预约充电，以及后续操作的主要步骤。

```mermaid
graph TD
    %% --- 搜索与选择 ---
    A[用户打开App] --> B(...) --> H[App显示充电站详情页]
    H --> I[用户选择一个空闲的可预约充电桩]
    I --> J[App显示桩预约详情: 预约规则, 取消费用说明]

    %% --- 预约与支付 (关键修改) ---
    J --> K[用户确认并点击“预约”]
    %% <-- 增加预约金环节
    K --> L{平台处理预约请求 & 要求支付预约金/预授权} 
    L -- 支付/授权成功 --> M[平台创建预约订单: 状态'已预约', 并锁定桩]
    L -- 支付/授权失败 --> L_Fail[App提示: 预约失败, 支付/授权不成功]
    L_Fail --> H

    M --> N[App显示“预约成功”: 含时长,桩号,导航入口]
    N --> N_Notify[平台发送预约成功通知]
    
    %% --- 预约期间的用户操作 (关键修改) ---
    N --> O{用户在预约有效期内操作?}
    O -- 1. 提前取消预约 --> O_Cancel[App显示取消确认: 是否扣费]
    O_Cancel --> O_Cancel_Confirm{用户确认取消}
    O_Cancel_Confirm -- 是 --> P[平台取消预约, 按规则退/扣费]
    P --> P_End((流程结束))

    %% --- 抵达与启动 (关键修改) ---
    O -- 2. 抵达后准备充电 --> Q[用户在App内点击'开始充电'或'扫码启动']
    Q --> R{平台验证: 是否本人? 是否预约桩? 是否在有效期内?}
    R -- 验证通过 --> S[平台结束预约单退还预约金, 创建充电单: 状态'启动中']
    S --> T[进入扫码充电流程的 M 节点] 
    R -- 验证失败(如扫错桩) --> R_Fail[App提示: 非预约桩, 请前往正确位置或取消预约]
    R_Fail --> N

    %% --- 异常与超时 (关键修改) ---
    O -- 3. 预约超时未启动 --> U[平台自动取消预约, 扣除爽约金]
    U --> U_Notify[平台发送预约超时取消通知]
    U_Notify --> P_End
    
    O -- 4. 申诉(如桩被占用) --> V[用户点击'申诉'入口]
    V --> W[引导用户拍照上传证据]
    W --> X[平台生成客服工单, 并取消预约，返还预约金]
    X --> P_End
```

### 流程解释：
1.  **搜寻与选择：** 用户通过筛选找到合适的充电站和空闲的可预约充电桩。
2.  **发起预约：** 用户确认预约详情后，App发送预约请求，平台处理并创建预约订单。
3.  **成功预约：** App显示预约成功信息，并收到通知。
4.  **预约提醒与抵达：** 平台在预约时间前发送提醒，用户抵达后前往预约桩。
5.  **启动充电：** 用户操作启动充电，平台验证预约并下发启动指令。
6.  **充电进行与结束：** 成功启动后，进入与扫码充电类似的充电流程。
7.  **预约超时处理：** 如果用户在规定时间内未启动充电，平台会自动取消预约并可能收取费用。

---

这些流程图为我们提供了用户视角下的核心操作路径。在后续的详细设计中，我们将基于这些流程图，进一步拆解需求，设计细化的API接口、数据库模型、错误处理机制、以及后台管理逻辑。