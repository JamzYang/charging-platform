好的，我们来设计 **用户扫码充电流程** 和 **用户预约充电流程**。

由于 Mermaid 流程图的特性，更适合表达清晰的步骤和决策路径。对于更复杂、涉及多系统交互的流程，通常会拆分为几个子流程或使用 BPMN 等更专业的工具。这里我将力求清晰地展示核心逻辑。

---

## 1. 用户扫码充电流程 (Mermaid Flowchart)

这个流程图将涵盖用户从打开 App 到完成充电支付的主要步骤。

```mermaid
graph TD
    A[用户打开App] --> B{是否已登录?}
    B -- 否 --> C[前往登录/注册]
    C --> B
    B -- 是 --> D[进入地图/充电入口]

    D --> E[选择“扫码充电”入口]
    E --> F[App启动扫码功能]
    F --> G{用户扫描充电桩二维码}

    G -- 扫描成功 --> H[App发送请求: 识别充电桩信息]
    H --> I{平台验证桩信息<br/>并获取实时状态}
    I -- 验证成功 & 空闲 --> J[App显示充电桩详情页: 功率, 费率, 状态]
    J --> K{用户确认并点击“启动充电”}

    K --> L[App发送请求: 启动充电<br/>- 携带用户ID, 桩ID, 启动方式]
    L --> M{平台处理充电请求}
    M -- 验证库存/状态/账户 --> N[平台发送指令: 启动充电桩]
    N -- 指令成功 --> O[充电桩确认启动]

    O --> P[平台更新充电订单状态: 开始计费]
    P --> Q[App显示充电中界面: 实时电量, 费用, 时长]

    Q --> R{充电结束方式?}
    R -- 达到设定值 --> S[充电桩自动结束]
    R -- 用户手动停止 --> T[App发送请求: 停止充电]
    R -- 其他异常 --> U[平台/桩自动停止]

    S --> V((充电结束))
    T --> M
    U --> M

    V --> W[平台计算最终费用]
    W --> X[App显示充电总结界面:总电量, 总费用, 时长]
    X --> Y{用户确认支付}
    Y -- 确认支付 --> Z[平台发起支付请求]
    Z -- 支付成功 --> AA[平台更新订单状态: 已支付]
    AA --> BB[App显示“支付成功”<br/>充电服务完成]

    M -- 失败/桩忙/异常 --> MF[App提示用户: 启动失败 或 桩忙]
    MF --> D

    I -- 验证失败/非空闲 --> IF[App提示用户: 桩不可用 或 信息错误]
    IF --> D

    Z -- 支付失败 --> ZF[App提示用户: 支付失败 请重试/更换方式]
    ZF --> X

```

### 流程解释：
1.  **准备阶段：** 用户打开App并登录。
2.  **扫码启动：** 用户通过App扫码，App将扫码结果发送给平台，平台验证桩信息并获取实时状态。
3.  **启动确认：** App显示桩详情，用户确认后点击启动，平台发送启动指令给充电桩。
4.  **充电进行中：** 充电成功启动后，App实时显示充电状态。
5.  **充电结束：** 充电可由多种方式（自动、手动、异常）结束。
6.  **费用结算与支付：** 平台计算最终费用，用户在App中完成支付。

---

## 2. 用户预约充电流程 (Mermaid Flowchart)

这个流程图将涵盖用户从搜索到预约充电，以及后续操作的主要步骤。

```mermaid
graph TD
    A[用户打开App] --> B{是否已登录?}
    B -- 否 --> C[前往登录/注册]
    C --> B
    B -- 是 --> D[进入地图/充电入口]
 
    D --> E[用户搜索充电站: 按条件筛选 如快充, 空闲数]
    E --> F[App显示符合条件的充电站列表/地图]
    F --> G[用户选择一个充电站]
    G --> H[App显示充电站详情页: 所有桩列表, 状态, 费率]
    H --> I[用户选择一个空闲的可预约充电桩]
 
    I --> J[App显示桩预约详情: 可预约时间段, 预约规则]
    J --> K{用户确认并点击“预约”}
    K -- 确认预约 --> L[App发送请求: 创建预约订单<br/>- 携带用户ID, 桩ID, 预约时间段]
    L --> M{平台处理预约请求}
 
    M -- 验证桩状态/预约冲突 --> N[平台创建预约订单]
    N -- 预约成功 --> O[App显示“预约成功”<br/>含预约时长, 预约桩号, 到期时间]
    O --> P[平台发送预约成功通知: App消息]
 
    O --> Q{预约时间临近或用户到达?}
    Q -- 临近前N分钟 --> R[平台发送预约提醒通知]
    Q -- 用户抵达 --> S[用户前往预约的充电桩]
    S --> T[用户选择“启动充电”: 可能扫码或手动选择]
    T -- 发起启动 --> U{平台验证预约订单<br/>并匹配桩}
 
    U -- 验证成功 --> V[平台发送指令: 启动充电桩]
    V -- 指令成功 --> W[充电桩确认启动]
    W --> X[平台更新预约订单状态<br/>开始计费, 结束预约]
    X --> Y[App显示充电中界面<br/>进入充电流程]
 
    M -- 预约失败 --> MF[App提示用户: 预约失败 或 桩不可用]
    MF --> H
 
    Q -- 预约超时未启动 --> Z[平台自动取消预约<br/> 计爽约]
    Z --> ZA[平台发送预约取消通知]
    ZA --> FB((流程结束))
 
    T -- 启动失败 --> TF[App提示用户: 启动失败 ]
    TF --> S
 
    Y -- 充电流程结束 --> FC((充电支付流程))
```

### 流程解释：
1.  **搜寻与选择：** 用户通过筛选找到合适的充电站和空闲的可预约充电桩。
2.  **发起预约：** 用户确认预约详情后，App发送预约请求，平台处理并创建预约订单。
3.  **成功预约：** App显示预约成功信息，并收到通知。
4.  **预约提醒与抵达：** 平台在预约时间前发送提醒，用户抵达后前往预约桩。
5.  **启动充电：** 用户操作启动充电，平台验证预约并下发启动指令。
6.  **充电进行与结束：** 成功启动后，进入与扫码充电类似的充电流程。
7.  **预约超时处理：** 如果用户在规定时间内未启动充电，平台会自动取消预约并可能收取费用。

---

这些流程图为我们提供了用户视角下的核心操作路径。在后续的详细设计中，我们将基于这些流程图，进一步拆解需求，设计细化的API接口、数据库模型、错误处理机制、以及后台管理逻辑。