# 20250716-1259-修复端到端（E2E）测试流程

## 📝 任务背景

在执行 `charge-point-gateway/test/e2e/business_flow/complete_charging_session_test.go` 端到端测试时，遇到了测试失败或卡死的问题。本报告记录了从初步诊断到最终解决的完整排查过程。

## 🛠️ 调试与问题解决

### [2025-07-16 12:26] - 问题：`no handler registered for protocol version 1.6`

*   **症状**: Gateway 服务日志明确指出，虽然 WebSocket 连接已建立，但无法为 `ocpp1.6` 协议找到对应的处理器。同时，测试客户端因收不到 `BootNotification` 的响应而超时。
*   **分析**: 初步怀疑是 `main.go` 中协议处理器的注册逻辑有误，或者在消息分发时用于查找处理器的 `key`（协议版本字符串）与注册时的 `key` 不匹配。
*   **验证**:
    1.  审查 `cmd/gateway/main.go`，确认 `dispatcher.RegisterHandler` 的注册逻辑存在。
    2.  审查 `internal/gateway/dispatcher.go`，确认其使用传入的协议版本字符串作为 `map` 的 `key` 进行查找。
    3.  审查 `internal/domain/protocol/constants.go`，确认注册和查找时使用的版本字符串（`"ocpp1.6"`）是匹配的。
*   **结论**: 初步假设不成立。问题根源更为复杂。

### [2025-07-16 12:29] - 问题：发现双重消息处理与响应丢失

*   **症状**: 深入分析代码后，发现存在两个代码路径可以处理 WebSocket 消息。
*   **分析**:
    1.  **路径一 (主路径)**: `websocket.Manager` 的 `receiveRoutine` -> `handleMessage` -> `dispatcher.DispatchMessage`。此路径是架构设计中的预期路径。
    2.  **路径二 (冗余路径)**: `websocket.Manager` 的 `receiveRoutine` 发送事件 -> `main.go` 的事件处理循环 -> `dispatcher.DispatchMessage`。
    3.  **根本原因**: `handleMessage` 方法在调用 `dispatcher` 后，**没有处理返回的响应**，导致客户端永远等不到回复，测试因此卡死。同时，该方法在处理协议版本时，**未调用 `NormalizeVersion` 函数**，存在潜在的版本不匹配风险。
*   **解决方案**:
    1.  **移除冗余路径**: 修改 `main.go`，使其事件循环不再处理 `EventTypeMessage`。
    2.  **修复主路径**: 修改 `manager.go` 的 `handleMessage` 方法，使其能够正确处理 `dispatcher` 返回的响应，并将响应发送回客户端。
    3.  **修复日志注入**: 发现各模块使用独立的、未配置的日志器，妨碍了调试。修改各模块构造函数，统一由 `main.go` 注入全局日志器。

### [2025-07-16 12:40] - 问题：`port "6379" not found` 与测试环境错误

*   **症状**: 在修复了代码逻辑后，测试失败并报告无法连接 Redis (`port "6379" not found`)。
*   **分析**: 结合 `测试执行指南.md`，意识到 E2E 测试需要一个由 Docker Compose 预先启动的完整环境。我们之前的操作（直接运行 `go test`）没有启动这些依赖服务。
*   **解决方案**:
    1.  **构建镜像**: 由于我们修改了代码，必须重新构建 `gateway-test` 服务的 Docker 镜像。
    2.  **启动环境**: 使用 `docker-compose -f test/docker-compose.test.yml up -d` 启动/重启服务。

### [2025-07-16 12:48] - 问题：E2E 测试错误地使用了 TestContainers

*   **症状**: 在正确的 Docker Compose 环境下运行测试，依然失败，错误日志显示 `TestContainers Kafka address...` 和 `context deadline exceeded`。
*   **分析**: `test/utils/test_helpers.go` 中的 `SetupTestEnvironment` 函数逻辑有误。它默认启用 TestContainers，而不是根据测试类型进行区分。E2E 测试因此没有连接到 Docker Compose 提供的稳定环境，而是尝试动态创建一套新的、但最终超时的容器。
*   **解决方案**: 修改 `test_helpers.go` 中的 `useTestContainers` 函数，使其仅在环境变量 `USE_TESTCONTAINERS` 明确设置为 `"true"` 时才启动 TestContainers。这确保了 E2E 测试默认使用外部环境。

### [2025-07-16 12:50] - 问题：下行指令格式错误

*   **症状**: 在修复了上行消息和测试环境后，测试卡在等待 `RemoteStartTransaction` 指令的步骤。
*   **分析**: 问题转移到了下行消息路径。经排查，`wsManager.SendCommand` 方法在收到 Kafka 的业务指令（`message.Command`）后，直接将其序列化为 JSON 对象，而不是 OCPP 协议要求的 JSON 数组 `[2, "message-id", "Action", {...}]`。
*   **解决方案**: 修改 `manager.go` 的 `SendCommand` 方法，手动将 `message.Command` 结构体转换为正确的 OCPP Call 数组格式，然后再进行序列化和发送。

### [2025-07-16 12:55] - 问题：编译失败 `command.MessageID undefined`

*   **症状**: 在修复下行指令格式时，构建失败。
*   **分析**: `message.Command` 结构体中并不包含 `MessageID` 字段，这是一个协议层面的概念。
*   **解决方案**: 修改 `SendCommand` 方法，不再从 `command` 对象中读取 `MessageID`，而是在发送时动态生成一个唯一的 ID。

### [2025-07-16 13:03] - 问题：下行指令 Kafka 消息反序列化失败

*   **症状**: 修复了所有已知问题并重新构建、部署后，测试依然卡在等待下行指令。查看 Gateway 日志，发现 Kafka 消费者已成功启动，但没有任何处理下行指令的日志。
*   **分析**: 这表明消费者收到了消息，但在处理时失败了。最可能的原因是消息体（JSON）的字段名与 `message.Command` 结构体的 `json` 标签不匹配。经检查，测试代码中构造指令时使用了下划线命名 (`charge_point_id`)，而 `Command` 结构体期望的是驼峰式命名 (`chargePointId`)。
*   **解决方案**: 修改 `complete_charging_session_test.go`，将发送到 Kafka 的指令的字段名全部修正为驼峰式。

### [2025-07-16 13:08] - 问题：Kafka 消息时序问题

*   **症状**: 即使修复了所有代码和数据格式问题，测试在某些情况下仍然失败，表现为消费者似乎没有收到消息。
*   **分析**: 这是分布式系统中一个典型的时序问题（Race Condition）。测试代码发送 Kafka 消息的动作，与 Gateway 中 Kafka 消费者完成初始化并准备好接收消息的动作，这两个动作之间没有同步机制。测试代码可能在消费者准备好之前就把消息发送出去了，导致消息丢失。
*   **解决方案**: 在测试代码中，发送 Kafka 消息前，增加一个短暂的 `time.Sleep` 延时（例如 1-2 秒）。这虽然不是最优雅的解决方案（更好的方案是实现一个健康检查或回调机制），但对于测试场景来说，是简单有效的，可以给消费者组足够的时间完成 Rebalance 并开始消费。

## 总结

本次故障排查过程是一次典型的多层次、多阶段的调试。问题从最初的 **协议处理器未注册**，到 **代码逻辑层面的双重处理和响应丢失**，再到 **测试环境层面的配置错误**，最后定位到 **上下行消息的协议格式转换错误** 和 **分布式系统中的时序问题**。通过系统地分析症状、提出并验证假设、逐步修复和验证，最终完整地解决了整个端到端测试流程中的所有障碍。