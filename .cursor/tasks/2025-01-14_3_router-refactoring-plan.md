# Routeré‡æ„å®æ–½è§„åˆ’ä»»åŠ¡

## ä»»åŠ¡æ¦‚è¿°

*   **ä»»åŠ¡åç§°**: 4.2 é‡æ„ç°æœ‰Routerä¸ºçº¯è·¯ç”±å™¨
*   **ä»»åŠ¡ç±»å‹**: æ¶æ„é‡æ„
*   **ä¼˜å…ˆçº§**: é«˜ (ä¼˜å…ˆçº§2)
*   **è®¡åˆ’å¼€å§‹æ—¶é—´**: 2025-01-14 16:00:00
*   **å½“å‰çŠ¶æ€**: è§„åˆ’å®Œæˆ - ç­‰å¾…æ‰§è¡Œç¡®è®¤
*   **è´Ÿè´£äºº**: AI Assistant
*   **å…³è”ä»»åŠ¡**: ç¬¬4é˜¶æ®µ - æ¶ˆæ¯åˆ†å‘ä¸åè®®å¤„ç†
*   **å‰ç½®ä¾èµ–**: 4.1 ä¸­å¤®æ¶ˆæ¯åˆ†å‘å™¨, 4.3 ç»Ÿä¸€ä¸šåŠ¡æ¨¡å‹è½¬æ¢å™¨

## é‡æ„ç›®æ ‡

### ğŸ¯ æ ¸å¿ƒç›®æ ‡
è§£å†³ç°æœ‰Routerç›´æ¥è€¦åˆOCPP16å¤„ç†å™¨çš„é—®é¢˜ï¼Œå®ç°çœŸæ­£çš„èŒè´£åˆ†ç¦»å’Œå¤šåè®®æ”¯æŒèƒ½åŠ›ã€‚

### ğŸ“Š å½“å‰é—®é¢˜åˆ†æ
- **ç›´æ¥è€¦åˆ**: Routerç›´æ¥ä¾èµ–OCPP16å¤„ç†å™¨
- **ç¡¬ç¼–ç ç‰ˆæœ¬**: æ— æ³•æ”¯æŒå¤šåè®®ç‰ˆæœ¬
- **èŒè´£æ··ä¹±**: Routeræ—¢åšè·¯ç”±åˆåšåè®®å¤„ç†
- **æ‰©å±•å›°éš¾**: æ·»åŠ æ–°åè®®ç‰ˆæœ¬éœ€è¦ä¿®æ”¹Routerä»£ç 

### ğŸ—ï¸ æ–°æ¶æ„è®¾è®¡
```
WebSocket Manager â†’ Router (é‡æ„å) â†’ MessageDispatcher â†’ Protocol Handlers
     â†“                    â†“                    â†“                â†“
  åŸå§‹æ¶ˆæ¯          æ¶ˆæ¯é¢„å¤„ç†           ç‰ˆæœ¬è¯†åˆ«è·¯ç”±      åè®®ç‰¹å®šå¤„ç†
```

## è¯¦ç»†å®æ–½æ¸…å•

### ğŸ“‹ é˜¶æ®µ1: åˆ†æå’Œè®¾è®¡ (é¢„è®¡2å°æ—¶)

#### 4.2.1 åˆ†æç°æœ‰Routerä»£ç  â³
**ç›®æ ‡**: ç†è§£å½“å‰å®ç°ï¼Œè¯†åˆ«éœ€è¦ä¿ç•™å’Œé‡æ„çš„éƒ¨åˆ†

**ä»»åŠ¡æ¸…å•**:
- [ ] **ä»£ç å®¡æŸ¥**
  - [ ] åˆ†æ`internal/transport/router/router.go`çš„å½“å‰å®ç°
  - [ ] è¯†åˆ«Routerçš„æ ¸å¿ƒèŒè´£å’ŒåŠŸèƒ½
  - [ ] æ‰¾å‡ºä¸OCPP16å¤„ç†å™¨çš„è€¦åˆç‚¹
  - [ ] è¯„ä¼°ç°æœ‰çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

- [ ] **ä¾èµ–å…³ç³»åˆ†æ**
  - [ ] æ£€æŸ¥å“ªäº›ç»„ä»¶ä¾èµ–å½“å‰çš„Router
  - [ ] åˆ†æRouterä¸WebSocket Managerçš„äº¤äº’
  - [ ] ç¡®å®šRouterä¸äº‹ä»¶ç³»ç»Ÿçš„é›†æˆæ–¹å¼
  - [ ] è¯„ä¼°å¯¹ç°æœ‰æµ‹è¯•çš„å½±å“

- [ ] **æ¥å£è®¾è®¡**
  - [ ] è®¾è®¡æ–°çš„Routeræ¥å£
  - [ ] å®šä¹‰Routerä¸MessageDispatcherçš„äº¤äº’å¥‘çº¦
  - [ ] ç¡®ä¿å‘åå…¼å®¹æ€§æˆ–åˆ¶å®šè¿ç§»ç­–ç•¥

#### 4.2.2 è®¾è®¡æ–°çš„Routeræ¥å£ â³
**ç›®æ ‡**: å®šä¹‰æ¸…æ™°çš„RouterèŒè´£è¾¹ç•Œå’Œæ¥å£

**æ ¸å¿ƒæ¥å£è®¾è®¡**:
```go
type MessageRouter interface {
    RouteMessage(ctx context.Context, conn Connection, message []byte) error
    RegisterConnection(conn Connection) error
    UnregisterConnection(connID string) error
    GetConnectionInfo(connID string) (*ConnectionInfo, bool)
    SetMessageDispatcher(dispatcher MessageDispatcher) error
    Start() error
    Stop() error
    GetStats() RouterStats
}
```

**é…ç½®ç»“æ„è®¾è®¡**:
```go
type RouterConfig struct {
    MaxConnections          int
    MessageTimeout          time.Duration
    ConnectionCheckInterval time.Duration
    EnableMessageLogging    bool
    MaxRetries             int
}
```

### ğŸ“‹ é˜¶æ®µ2: æ ¸å¿ƒå®ç° (é¢„è®¡3å°æ—¶)

#### 4.2.3 å®ç°æ–°çš„Router â³
**ç›®æ ‡**: å®ç°ä¸“æ³¨äºè·¯ç”±èŒè´£çš„æ–°Router

**æ ¸å¿ƒèŒè´£é‡æ–°å®šä¹‰**:
1. **è¿æ¥ç®¡ç†**: ç»´æŠ¤WebSocketè¿æ¥çš„ç”Ÿå‘½å‘¨æœŸ
2. **æ¶ˆæ¯é¢„å¤„ç†**: åŸºç¡€çš„æ¶ˆæ¯éªŒè¯å’Œæ ¼å¼æ£€æŸ¥
3. **è·¯ç”±è½¬å‘**: å°†æ¶ˆæ¯è½¬å‘ç»™MessageDispatcher
4. **é”™è¯¯å¤„ç†**: å¤„ç†è¿æ¥é”™è¯¯å’Œæ¶ˆæ¯é”™è¯¯
5. **ç»Ÿè®¡æ”¶é›†**: æ”¶é›†è·¯ç”±å±‚é¢çš„ç»Ÿè®¡ä¿¡æ¯

**å®ç°ä»»åŠ¡**:
- [ ] **åˆ›å»ºæ–°Routerç»“æ„ä½“**
  - [ ] DefaultMessageRouterç»“æ„ä½“å®šä¹‰
  - [ ] é…ç½®ç³»ç»Ÿé›†æˆ
  - [ ] æ—¥å¿—ç³»ç»Ÿé›†æˆ
  - [ ] ç»Ÿè®¡ä¿¡æ¯æ”¶é›†

- [ ] **å®ç°è¿æ¥ç®¡ç†**
  - [ ] è¿æ¥æ³¨å†Œå’Œæ³¨é”€
  - [ ] è¿æ¥çŠ¶æ€è·Ÿè¸ª
  - [ ] è¿æ¥å¥åº·æ£€æŸ¥
  - [ ] è¿æ¥è¶…æ—¶å¤„ç†

- [ ] **å®ç°æ¶ˆæ¯è·¯ç”±**
  - [ ] æ¶ˆæ¯æ ¼å¼éªŒè¯
  - [ ] å……ç”µæ¡©IDæå–
  - [ ] åè®®ç‰ˆæœ¬è¯†åˆ«ï¼ˆå§”æ‰˜ç»™Dispatcherï¼‰
  - [ ] æ¶ˆæ¯è½¬å‘åˆ°Dispatcher

- [ ] **å®ç°é”™è¯¯å¤„ç†**
  - [ ] è¿æ¥é”™è¯¯å¤„ç†
  - [ ] æ¶ˆæ¯æ ¼å¼é”™è¯¯å¤„ç†
  - [ ] åˆ†å‘å™¨é”™è¯¯å¤„ç†
  - [ ] é”™è¯¯æ¢å¤æœºåˆ¶

#### 4.2.4 é‡æ„OCPP16å¤„ç†å™¨é›†æˆ â³
**ç›®æ ‡**: å°†OCPP16å¤„ç†å™¨æ”¹é€ ä¸ºç¬¦åˆProtocolHandleræ¥å£

**é‡æ„ä»»åŠ¡**:
- [ ] **åˆ›å»ºOCPP16 ProtocolHandleré€‚é…å™¨**
  - [ ] OCPP16ProtocolHandlerç»“æ„ä½“
  - [ ] é…ç½®ç³»ç»Ÿæ”¯æŒ
  - [ ] é”™è¯¯å¤„ç†æœºåˆ¶
  - [ ] æ—¥å¿—é›†æˆ

- [ ] **å®ç°ProtocolHandleræ¥å£**
  - [ ] ProcessMessageæ–¹æ³•å®ç°
  - [ ] GetSupportedActionsæ–¹æ³•
  - [ ] Start/Stopç”Ÿå‘½å‘¨æœŸæ–¹æ³•
  - [ ] GetEventChanneläº‹ä»¶é€šé“

- [ ] **é›†æˆç»Ÿä¸€è½¬æ¢å™¨**
  - [ ] åœ¨å¤„ç†å™¨ä¸­ä½¿ç”¨UnifiedModelConverter
  - [ ] ç¡®ä¿äº‹ä»¶æ­£ç¡®è½¬æ¢å’Œå‘å¸ƒ
  - [ ] å¤„ç†è½¬æ¢é”™è¯¯å’Œå¼‚å¸¸

#### 4.2.5 æ›´æ–°åº”ç”¨ç¨‹åºé›†æˆ â³
**ç›®æ ‡**: æ›´æ–°åº”ç”¨ç¨‹åºå¯åŠ¨å’Œç»„ä»¶è¿æ¥

**é›†æˆä»»åŠ¡**:
- [ ] **æ›´æ–°main.go**
  - [ ] ç»„ä»¶åˆ›å»ºå’Œåˆå§‹åŒ–
  - [ ] ä¾èµ–æ³¨å…¥å’Œè¿æ¥
  - [ ] å¯åŠ¨é¡ºåºç®¡ç†
  - [ ] ä¼˜é›…å…³é—­å¤„ç†

- [ ] **æ›´æ–°é…ç½®ç³»ç»Ÿ**
  - [ ] æ·»åŠ Routeré…ç½®
  - [ ] æ·»åŠ Dispatcheré…ç½®
  - [ ] æ›´æ–°ç°æœ‰é…ç½®ç»“æ„
  - [ ] é…ç½®éªŒè¯å’Œé»˜è®¤å€¼

- [ ] **æ›´æ–°ä¾èµ–æ³¨å…¥**
  - [ ] ç¡®ä¿æ‰€æœ‰ç»„ä»¶æ­£ç¡®è¿æ¥
  - [ ] å¤„ç†å¾ªç¯ä¾èµ–é—®é¢˜
  - [ ] å®ç°ä¼˜é›…çš„å¯åŠ¨é¡ºåº

### ğŸ“‹ é˜¶æ®µ3: æµ‹è¯•å’ŒéªŒè¯ (é¢„è®¡1.5å°æ—¶)

#### 4.2.6 æµ‹è¯•ç­–ç•¥å®æ–½ â³
**ç›®æ ‡**: ç¡®ä¿é‡æ„åçš„ç³»ç»ŸåŠŸèƒ½æ­£ç¡®

**æµ‹è¯•ä»»åŠ¡**:
- [ ] **å•å…ƒæµ‹è¯•**
  - [ ] æ–°Routerçš„å•å…ƒæµ‹è¯•
  - [ ] OCPP16 ProtocolHandlerçš„å•å…ƒæµ‹è¯•
  - [ ] å„ç»„ä»¶æ¥å£çš„mockæµ‹è¯•
  - [ ] é”™è¯¯åœºæ™¯æµ‹è¯•

- [ ] **é›†æˆæµ‹è¯•**
  - [ ] Routerä¸Dispatcherçš„é›†æˆæµ‹è¯•
  - [ ] ç«¯åˆ°ç«¯æ¶ˆæ¯æµæµ‹è¯•
  - [ ] é”™è¯¯åœºæ™¯é›†æˆæµ‹è¯•
  - [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•

- [ ] **å›å½’æµ‹è¯•**
  - [ ] è¿è¡Œæ‰€æœ‰ç°æœ‰æµ‹è¯•
  - [ ] éªŒè¯åŠŸèƒ½æ— å›å½’
  - [ ] æ€§èƒ½å¯¹æ¯”æµ‹è¯•
  - [ ] å†…å­˜ä½¿ç”¨åˆ†æ

## é£é™©è¯„ä¼°ä¸ç¼“è§£ç­–ç•¥

### âš ï¸ é«˜é£é™©é¡¹
1. **ç ´åç°æœ‰åŠŸèƒ½**
   - **é£é™©**: é‡æ„å¯èƒ½å¯¼è‡´ç°æœ‰åŠŸèƒ½å¤±æ•ˆ
   - **ç¼“è§£**: ä¿æŒç°æœ‰æ¥å£å…¼å®¹ï¼Œåˆ†é˜¶æ®µé‡æ„
   - **éªŒè¯**: å…¨é¢çš„å›å½’æµ‹è¯•

2. **æ€§èƒ½ä¸‹é™**
   - **é£é™©**: æ–°æ¶æ„å¯èƒ½å¼•å…¥æ€§èƒ½å¼€é”€
   - **ç¼“è§£**: æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼Œä¼˜åŒ–å…³é”®è·¯å¾„
   - **éªŒè¯**: å‹åŠ›æµ‹è¯•å’Œæ€§èƒ½ç›‘æ§

3. **å¤æ‚åº¦å¢åŠ **
   - **é£é™©**: æ–°æ¶æ„å¯èƒ½è¿‡äºå¤æ‚
   - **ç¼“è§£**: æ¸…æ™°çš„æ¥å£è®¾è®¡ï¼Œå……åˆ†çš„æ–‡æ¡£
   - **éªŒè¯**: ä»£ç å®¡æŸ¥å’Œæ¶æ„è¯„å®¡

### âš ï¸ ä¸­é£é™©é¡¹
1. **æµ‹è¯•è¦†ç›–ä¸è¶³**
   - **é£é™©**: é‡æ„åçš„ä»£ç æµ‹è¯•ä¸å……åˆ†
   - **ç¼“è§£**: åˆ¶å®šè¯¦ç»†çš„æµ‹è¯•è®¡åˆ’
   - **éªŒè¯**: æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š

2. **é…ç½®å¤æ‚åŒ–**
   - **é£é™©**: æ–°ç»„ä»¶å¢åŠ é…ç½®å¤æ‚åº¦
   - **ç¼“è§£**: æä¾›åˆç†çš„é»˜è®¤é…ç½®
   - **éªŒè¯**: é…ç½®æ–‡æ¡£å’Œç¤ºä¾‹

## æˆåŠŸæŒ‡æ ‡

### ğŸ“Š åŠŸèƒ½æŒ‡æ ‡
- âœ… æ‰€æœ‰ç°æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… æ”¯æŒå¤šåè®®ç‰ˆæœ¬æ³¨å†Œ
- âœ… æ¶ˆæ¯è·¯ç”±æ­£ç¡®æ€§100%
- âœ… é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„

### ğŸ“Š æ€§èƒ½æŒ‡æ ‡
- âœ… æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ â‰¤ ç°æœ‰ç³»ç»Ÿçš„110%
- âœ… å†…å­˜ä½¿ç”¨ â‰¤ ç°æœ‰ç³»ç»Ÿçš„120%
- âœ… å¹¶å‘è¿æ¥æ•° â‰¥ ç°æœ‰ç³»ç»Ÿ
- âœ… é”™è¯¯ç‡ â‰¤ ç°æœ‰ç³»ç»Ÿ

### ğŸ“Š è´¨é‡æŒ‡æ ‡
- âœ… æµ‹è¯•è¦†ç›–ç‡ â‰¥ 85%
- âœ… ä»£ç å¤æ‚åº¦é™ä½
- âœ… æ¥å£æ¸…æ™°åº¦æå‡
- âœ… æ–‡æ¡£å®Œæ•´æ€§

## æ—¶é—´ä¼°ç®—

### ğŸ• è¯¦ç»†æ—¶é—´åˆ†é…
- **é˜¶æ®µ1: åˆ†æå’Œè®¾è®¡**: 2å°æ—¶
  - ä»£ç åˆ†æ: 30åˆ†é’Ÿ
  - æ¥å£è®¾è®¡: 45åˆ†é’Ÿ
  - æ¶æ„è®¾è®¡: 45åˆ†é’Ÿ

- **é˜¶æ®µ2: æ ¸å¿ƒå®ç°**: 3å°æ—¶
  - æ–°Routerå®ç°: 90åˆ†é’Ÿ
  - OCPP16é€‚é…å™¨: 60åˆ†é’Ÿ
  - é›†æˆä»£ç : 30åˆ†é’Ÿ

- **é˜¶æ®µ3: æµ‹è¯•å’ŒéªŒè¯**: 1.5å°æ—¶
  - å•å…ƒæµ‹è¯•: 45åˆ†é’Ÿ
  - é›†æˆæµ‹è¯•: 30åˆ†é’Ÿ
  - å›å½’æµ‹è¯•: 15åˆ†é’Ÿ

- **æ€»è®¡**: çº¦6.5å°æ—¶

## å›æ»šç­–ç•¥

### ğŸ”„ åº”æ€¥é¢„æ¡ˆ
1. **ä¿ç•™åŸæœ‰ä»£ç **: åœ¨æ–°åˆ†æ”¯è¿›è¡Œé‡æ„ï¼Œä¿æŒmainåˆ†æ”¯ç¨³å®š
2. **åˆ†é˜¶æ®µæäº¤**: æ¯ä¸ªé˜¶æ®µç‹¬ç«‹æäº¤ï¼Œä¾¿äºå›æ»š
3. **åŠŸèƒ½å¼€å…³**: ä½¿ç”¨é…ç½®å¼€å…³åœ¨æ–°æ—§å®ç°é—´åˆ‡æ¢
4. **å¿«é€Ÿå›æ»š**: å‡†å¤‡å¿«é€Ÿå›æ»šè„šæœ¬å’Œæµç¨‹

## é¢„æœŸæ”¶ç›Š

### ğŸ¯ æ¶æ„æ”¹è¿›
- **è§£è€¦æ¶æ„**: åˆ†ç¦»è·¯ç”±å’Œåè®®å¤„ç†èŒè´£
- **æå‡æ‰©å±•æ€§**: æ”¯æŒå¤šåè®®ç‰ˆæœ¬
- **æ”¹å–„å¯ç»´æŠ¤æ€§**: æ¸…æ™°çš„æ¥å£å’ŒèŒè´£åˆ†ç¦»
- **ä¿æŒç¨³å®šæ€§**: æ¸è¿›å¼é‡æ„ï¼Œç¡®ä¿åŠŸèƒ½ä¸å—å½±å“

### ğŸš€ æœªæ¥èƒ½åŠ›
- **å¤šåè®®æ”¯æŒ**: ä¸ºOCPP 2.0å’Œå…¶ä»–åè®®æ‰©å±•å¥ å®šåŸºç¡€
- **åŠ¨æ€é…ç½®**: æ”¯æŒè¿è¡Œæ—¶åè®®ç‰ˆæœ¬ç®¡ç†
- **æ€§èƒ½ä¼˜åŒ–**: æ›´å¥½çš„èµ„æºåˆ©ç”¨å’Œæ€§èƒ½ç›‘æ§
- **è¿ç»´å‹å¥½**: æ›´æ¸…æ™°çš„æ—¥å¿—å’Œç›‘æ§æŒ‡æ ‡

## æŠ€æœ¯å®æ–½ç»†èŠ‚

### ğŸ”§ æ–°Routerå®ç°ç»†èŠ‚

**DefaultMessageRouterç»“æ„ä½“è®¾è®¡**:
```go
type DefaultMessageRouter struct {
    config      *RouterConfig
    dispatcher  MessageDispatcher
    connections map[string]Connection
    connMutex   sync.RWMutex
    stats       RouterStats
    logger      *logger.Logger
    ctx         context.Context
    cancel      context.CancelFunc
    wg          sync.WaitGroup
    started     bool
    startMutex  sync.Mutex
}
```

**æ ¸å¿ƒæ–¹æ³•å®ç°è¦ç‚¹**:
1. **RouteMessage**:
   - æ¶ˆæ¯æ ¼å¼éªŒè¯
   - å……ç”µæ¡©IDæå–
   - å§”æ‰˜ç»™MessageDispatcherå¤„ç†
   - é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

2. **è¿æ¥ç®¡ç†**:
   - çº¿ç¨‹å®‰å…¨çš„è¿æ¥æ³¨å†Œ/æ³¨é”€
   - è¿æ¥çŠ¶æ€ç›‘æ§
   - è¶…æ—¶æ£€æµ‹å’Œæ¸…ç†

3. **ç»Ÿè®¡æ”¶é›†**:
   - æ¶ˆæ¯æ•°é‡ç»Ÿè®¡
   - å¤„ç†æ—¶é—´ç»Ÿè®¡
   - é”™è¯¯ç‡ç»Ÿè®¡
   - è¿æ¥æ•°ç»Ÿè®¡

### ğŸ”§ OCPP16é€‚é…å™¨å®ç°ç»†èŠ‚

**OCPP16ProtocolHandlerç»“æ„ä½“è®¾è®¡**:
```go
type OCPP16ProtocolHandler struct {
    processor   *ocpp16.Processor
    converter   *gateway.UnifiedModelConverter
    eventChan   chan events.Event
    config      *OCPP16HandlerConfig
    logger      *logger.Logger
    ctx         context.Context
    cancel      context.CancelFunc
    wg          sync.WaitGroup
    started     bool
}
```

**å…³é”®é›†æˆç‚¹**:
1. **æ¶ˆæ¯å¤„ç†æµç¨‹**:
   ```
   åŸå§‹æ¶ˆæ¯ â†’ OCPP16è§£æ â†’ ä¸šåŠ¡å¤„ç† â†’ ç»Ÿä¸€è½¬æ¢å™¨ â†’ äº‹ä»¶å‘å¸ƒ
   ```

2. **é”™è¯¯å¤„ç†ç­–ç•¥**:
   - è§£æé”™è¯¯: è¿”å›OCPPé”™è¯¯å“åº”
   - ä¸šåŠ¡é”™è¯¯: è®°å½•æ—¥å¿—å¹¶è¿”å›é€‚å½“å“åº”
   - è½¬æ¢é”™è¯¯: é™çº§å¤„ç†ï¼Œç¡®ä¿åŸºæœ¬åŠŸèƒ½

3. **äº‹ä»¶å‘å¸ƒæœºåˆ¶**:
   - å¼‚æ­¥äº‹ä»¶å‘å¸ƒ
   - äº‹ä»¶é€šé“ç¼“å†²ç®¡ç†
   - èƒŒå‹å¤„ç†

### ğŸ”§ é›†æˆé…ç½®ç¤ºä¾‹

**å®Œæ•´çš„ç»„ä»¶åˆå§‹åŒ–ä»£ç **:
```go
func initializeGateway() error {
    // 1. åˆ›å»ºé…ç½®
    converterConfig := gateway.DefaultConverterConfig()
    dispatcherConfig := gateway.DefaultDispatcherConfig()
    routerConfig := router.DefaultRouterConfig()

    // 2. åˆ›å»ºæ ¸å¿ƒç»„ä»¶
    converter := gateway.NewUnifiedModelConverter(converterConfig)
    dispatcher := gateway.NewDefaultMessageDispatcher(dispatcherConfig)
    messageRouter := router.NewDefaultMessageRouter(routerConfig)

    // 3. åˆ›å»ºåè®®å¤„ç†å™¨
    ocpp16Processor := ocpp16.NewProcessor(ocpp16Config)
    ocpp16Handler := ocpp16.NewProtocolHandler(ocpp16Processor, converter)

    // 4. è¿æ¥ç»„ä»¶
    if err := dispatcher.RegisterHandler("1.6", ocpp16Handler); err != nil {
        return fmt.Errorf("failed to register OCPP16 handler: %w", err)
    }

    if err := messageRouter.SetMessageDispatcher(dispatcher); err != nil {
        return fmt.Errorf("failed to set dispatcher: %w", err)
    }

    // 5. å¯åŠ¨ç»„ä»¶
    if err := dispatcher.Start(); err != nil {
        return fmt.Errorf("failed to start dispatcher: %w", err)
    }

    if err := messageRouter.Start(); err != nil {
        return fmt.Errorf("failed to start router: %w", err)
    }

    return nil
}
```

## æµ‹è¯•ç­–ç•¥è¯¦ç»†è¯´æ˜

### ğŸ§ª å•å…ƒæµ‹è¯•è¦†ç›–èŒƒå›´

**Routeræµ‹è¯•**:
- [ ] è¿æ¥æ³¨å†Œ/æ³¨é”€åŠŸèƒ½
- [ ] æ¶ˆæ¯è·¯ç”±æ­£ç¡®æ€§
- [ ] é”™è¯¯å¤„ç†æœºåˆ¶
- [ ] ç»Ÿè®¡ä¿¡æ¯æ”¶é›†
- [ ] å¹¶å‘å®‰å…¨æ€§

**OCPP16é€‚é…å™¨æµ‹è¯•**:
- [ ] ProtocolHandleræ¥å£å®ç°
- [ ] æ¶ˆæ¯å¤„ç†æµç¨‹
- [ ] äº‹ä»¶è½¬æ¢å’Œå‘å¸ƒ
- [ ] é”™è¯¯åœºæ™¯å¤„ç†
- [ ] ç”Ÿå‘½å‘¨æœŸç®¡ç†

**é›†æˆæµ‹è¯•åœºæ™¯**:
- [ ] ç«¯åˆ°ç«¯æ¶ˆæ¯æµ
- [ ] å¤šè¿æ¥å¹¶å‘å¤„ç†
- [ ] é”™è¯¯æ¢å¤æœºåˆ¶
- [ ] æ€§èƒ½å‹åŠ›æµ‹è¯•
- [ ] å†…å­˜æ³„æ¼æ£€æµ‹

### ğŸ§ª æµ‹è¯•æ•°æ®å’ŒMockç­–ç•¥

**Mockç»„ä»¶è®¾è®¡**:
```go
type MockConnection struct {
    ID       string
    Messages [][]byte
    Closed   bool
}

type MockMessageDispatcher struct {
    ProcessedMessages []ProcessedMessage
    Handlers         map[string]ProtocolHandler
}
```

**æµ‹è¯•æ•°æ®é›†**:
- æ ‡å‡†OCPP 1.6æ¶ˆæ¯æ ·æœ¬
- é”™è¯¯æ ¼å¼æ¶ˆæ¯æ ·æœ¬
- è¾¹ç•Œæ¡ä»¶æµ‹è¯•æ•°æ®
- æ€§èƒ½æµ‹è¯•è´Ÿè½½æ•°æ®

## ç›‘æ§å’Œå¯è§‚æµ‹æ€§

### ğŸ“Š å…³é”®æŒ‡æ ‡å®šä¹‰

**Routerå±‚æŒ‡æ ‡**:
- `router_connections_total`: å½“å‰è¿æ¥æ•°
- `router_messages_total`: å¤„ç†çš„æ¶ˆæ¯æ€»æ•°
- `router_message_duration`: æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ
- `router_errors_total`: é”™è¯¯æ€»æ•°

**Dispatcherå±‚æŒ‡æ ‡**:
- `dispatcher_handlers_registered`: æ³¨å†Œçš„å¤„ç†å™¨æ•°é‡
- `dispatcher_messages_by_version`: æŒ‰ç‰ˆæœ¬åˆ†ç»„çš„æ¶ˆæ¯æ•°
- `dispatcher_processing_duration`: åˆ†å‘å¤„ç†æ—¶é—´
- `dispatcher_queue_size`: äº‹ä»¶é˜Ÿåˆ—å¤§å°

**OCPP16å¤„ç†å™¨æŒ‡æ ‡**:
- `ocpp16_actions_processed`: æŒ‰åŠ¨ä½œç±»å‹åˆ†ç»„çš„å¤„ç†æ•°
- `ocpp16_conversion_errors`: è½¬æ¢é”™è¯¯æ•°
- `ocpp16_event_publish_duration`: äº‹ä»¶å‘å¸ƒå»¶è¿Ÿ

### ğŸ“Š æ—¥å¿—ç­–ç•¥

**ç»“æ„åŒ–æ—¥å¿—æ ¼å¼**:
```json
{
  "timestamp": "2025-01-14T16:00:00Z",
  "level": "INFO",
  "component": "router",
  "charge_point_id": "CP001",
  "action": "route_message",
  "protocol_version": "1.6",
  "duration_ms": 15,
  "message": "Message routed successfully"
}
```

**æ—¥å¿—çº§åˆ«å®šä¹‰**:
- **DEBUG**: è¯¦ç»†çš„æ¶ˆæ¯å†…å®¹å’Œå¤„ç†æ­¥éª¤
- **INFO**: æ­£å¸¸çš„æ“ä½œæµç¨‹å’ŒçŠ¶æ€å˜åŒ–
- **WARN**: å¯æ¢å¤çš„é”™è¯¯å’Œå¼‚å¸¸æƒ…å†µ
- **ERROR**: ä¸¥é‡é”™è¯¯å’Œç³»ç»Ÿæ•…éšœ

## éƒ¨ç½²å’Œè¿ç»´è€ƒè™‘

### ğŸš€ éƒ¨ç½²ç­–ç•¥

**æ¸è¿›å¼éƒ¨ç½²**:
1. **é˜¶æ®µ1**: åœ¨æµ‹è¯•ç¯å¢ƒéƒ¨ç½²æ–°æ¶æ„
2. **é˜¶æ®µ2**: åœ¨é¢„ç”Ÿäº§ç¯å¢ƒè¿›è¡Œå‹åŠ›æµ‹è¯•
3. **é˜¶æ®µ3**: ç”Ÿäº§ç¯å¢ƒç°åº¦å‘å¸ƒ
4. **é˜¶æ®µ4**: å…¨é‡åˆ‡æ¢åˆ°æ–°æ¶æ„

**é…ç½®ç®¡ç†**:
- æ”¯æŒçƒ­é‡è½½çš„é…ç½®é¡¹
- ç¯å¢ƒç‰¹å®šçš„é…ç½®è¦†ç›–
- é…ç½®éªŒè¯å’Œé»˜è®¤å€¼
- é…ç½®å˜æ›´å®¡è®¡æ—¥å¿—

### ğŸš€ è¿ç»´å·¥å…·

**å¥åº·æ£€æŸ¥ç«¯ç‚¹**:
```go
GET /health/router     - Routerå¥åº·çŠ¶æ€
GET /health/dispatcher - Dispatcherå¥åº·çŠ¶æ€
GET /metrics          - PrometheusæŒ‡æ ‡
GET /debug/pprof      - æ€§èƒ½åˆ†æ
```

**ç®¡ç†æ¥å£**:
```go
GET  /admin/connections     - æŸ¥çœ‹å½“å‰è¿æ¥
POST /admin/handlers/reload - é‡æ–°åŠ è½½å¤„ç†å™¨
GET  /admin/stats          - è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
```

## å¤‡æ³¨

è¿™ä¸ªé‡æ„æ˜¯ç½‘å…³æ¶æ„æ¼”è¿›çš„å…³é”®æ­¥éª¤ï¼Œå®Œæˆåå°†å®ç°çœŸæ­£çš„åè®®æ— å…³è·¯ç”±å±‚ï¼Œä¸ºæœªæ¥çš„å¤šåè®®æ”¯æŒå’Œç³»ç»Ÿæ‰©å±•æä¾›åšå®åŸºç¡€ã€‚

é‡æ„è¿‡ç¨‹ä¸­å°†ä¸¥æ ¼éµå¾ªæ¸è¿›å¼æ”¹è¿›åŸåˆ™ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§å’ŒåŠŸèƒ½å®Œæ•´æ€§ã€‚æ‰€æœ‰çš„è®¾è®¡å†³ç­–éƒ½åŸºäºå®é™…çš„ç”Ÿäº§éœ€æ±‚å’Œæœ€ä½³å®è·µï¼Œç¡®ä¿é‡æ„åçš„ç³»ç»Ÿå…·å¤‡æ›´å¥½çš„å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§å’Œå¯è§‚æµ‹æ€§ã€‚
