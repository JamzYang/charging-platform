# 充电桩网关监控快速开始指南

## 🚀 启动方式

### 方式一：集成测试环境（推荐）
使用集成的test环境，支持可选监控服务：

```powershell
# 进入test目录
cd charge-point-gateway\test

# 启动测试环境 + 监控服务
docker-compose -f docker-compose.test.yml --profile monitoring up -d

# 只启动测试环境（不含监控）
docker-compose -f docker-compose.test.yml up -d

# 停止所有服务
docker-compose -f docker-compose.test.yml --profile monitoring down

# 查看服务状态
docker-compose -f docker-compose.test.yml --profile monitoring ps
```

### 方式二：独立监控环境
使用独立的监控服务：

```powershell
# 进入monitoring目录
cd charge-point-gateway\monitoring

# 启动监控服务
docker-compose -f docker-compose.monitoring.yml up -d

# 停止监控服务
docker-compose -f docker-compose.monitoring.yml down
```

## 🎉 监控栈启动成功

您的Prometheus + Grafana监控栈已经成功启动并运行。

## 📊 访问监控界面

### 集成环境访问地址
- **网关WebSocket**: `ws://localhost:8081/ocpp/{charge_point_id}`
- **网关健康检查**: http://localhost:8081/health
- **网关Metrics**: http://localhost:9091/metrics
- **Grafana**: http://localhost:3000 (admin/admin123)
- **Prometheus**: http://localhost:9090
- **AlertManager**: http://localhost:9093
- **Node Exporter**: http://localhost:9101
- **cAdvisor**: http://localhost:8085
- **Redis Metrics**: http://localhost:9121
- **Kafka Metrics**: http://localhost:9308

### Grafana 数据可视化界面
- **地址**: http://localhost:3000
- **用户名**: admin
- **密码**: admin123
- **功能**: 主要的监控仪表板，用于查看图表和指标

### Prometheus 指标查询界面
- **地址**: http://localhost:9090
- **功能**: 原始指标查询和规则管理

## 🚀 下一步操作

### 1. 登录Grafana
1. 打开浏览器访问 http://localhost:3000
2. 使用用户名 `admin` 和密码 `admin123` 登录
3. 首次登录可能会要求更改密码（可选）

### 2. 配置数据源
Prometheus数据源已经预配置，但您可以验证：
1. 在Grafana中，点击左侧菜单的 "Configuration" → "Data Sources"
2. 确认Prometheus数据源指向 `http://prometheus:9090`

### 3. 导入仪表板
我们已经为您准备了充电桩网关专用的仪表板模板。

### 4. 启动网关应用
为了看到实际的监控数据，您需要启动充电桩网关应用：


确保网关应用在端口9090暴露指标（/metrics端点）。

## 📈 性能测试监控

在进行性能测试时，重点关注以下指标：

### 连接性能
- 活跃WebSocket连接数
- 连接建立/断开速率
- 连接稳定性

### 消息处理性能
- 消息接收速率 (TPS)
- 消息处理延迟分布
- 错误率和超时率

### 系统资源
- CPU使用率
- 内存使用率和增长趋势
- 网络带宽使用

## 🛠️ 管理命令

### 查看服务状态
```powershell
docker-compose -f docker-compose.simple.yml ps
```

### 查看服务日志
```powershell
# 查看所有服务日志
docker-compose -f docker-compose.simple.yml logs

# 查看特定服务日志
docker-compose -f docker-compose.simple.yml logs grafana
docker-compose -f docker-compose.simple.yml logs prometheus
```

### 停止监控栈
```powershell
docker-compose -f docker-compose.simple.yml down
```

### 重启监控栈
```powershell
docker-compose -f docker-compose.simple.yml restart
```

## 🔧 自定义配置

### 修改Prometheus配置
编辑 `prometheus/prometheus-simple.yml` 文件来：
- 调整抓取间隔
- 添加新的监控目标
- 配置告警规则

### 创建自定义仪表板
1. 在Grafana中点击 "+" → "Dashboard"
2. 添加面板并配置查询
3. 保存仪表板

## 📝 常见问题

### Q: 无法访问Grafana界面
A: 确认Docker容器正在运行，检查端口3000是否被占用

### Q: Prometheus无法抓取网关指标
A: 确认网关应用正在运行并在正确端口暴露/metrics端点

### Q: 图表显示"No data"
A: 确认数据源配置正确，网关应用正在产生指标数据

## 🎯 性能测试建议

1. **基准测试**: 先建立无负载时的基准指标
2. **逐步加压**: 逐步增加连接数和消息频率
3. **监控关键指标**: 重点关注延迟、吞吐量和错误率
4. **资源监控**: 观察CPU、内存使用趋势
5. **记录结果**: 保存测试结果用于对比分析

## 📞 获取帮助

如果遇到问题，请检查：
1. Docker容器状态
2. 服务日志
3. 网络连接
4. 端口占用情况

祝您监控愉快！🎉

-----------

### 1. 分析：应该监控哪些核心数据？

您的监控系统已经通过多个 Exporter 收集了丰富的数据。为了全面了解系统健康状况，我们应该从以下几个维度来组织监控面板：

| 监控维度 | 数据来源 | 关键指标 (PromQL) | 监控目的 |
| :--- | :--- | :--- | :--- |
| **网关核心业务** | 网关应用 (`/metrics`) | `gateway_active_connections` | 实时查看当前有多少充电桩连接在网关上。 |
| | | `rate(gateway_messages_received_total[5m])` | 观察网关处理消息的速率 (TPS)，判断负载情况。 |
| | | `histogram_quantile(0.95, sum(rate(gateway_message_processing_duration_seconds_bucket[5m])) by (le))` | 监控95%的消息处理延迟，这是衡量性能的关键SLO。 |
| | | `rate(gateway_events_published_total{status="success"}[5m])` | 监控事件成功发布到Kafka的速率。 |
| | | `rate(gateway_events_published_total{status="failed"}[5m])` | **（重要）** 监控事件发布失败的速率，及时发现后端问题。 |
| **系统与容器资源** | Node Exporter, cAdvisor | `100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)` | 监控主机和容器的CPU使用率。 |
| | | `node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * 100` | 监控可用内存百分比。 |
| | | `container_memory_usage_bytes{name=~".*gateway.*"}` | 专门监控网关容器的内存使用情况。 |
| | | `rate(container_network_receive_bytes_total[5m])` | 监控容器的网络接收流量。 |
| **基础设施组件** | Redis Exporter, Kafka Exporter | `redis_connected_clients` | 监控Redis的客户端连接数。 |
| | | `rate(redis_commands_processed_total[5m])` | 监控Redis的命令处理速率。 |
| | | `kafka_consumergroup_lag` | **（重要）** 监控Kafka消费组的延迟，判断数据处理是否有积压。 |
| | | `rate(kafka_topic_partition_current_offset[5m])` | 监控Kafka主题分区的消息增长速率。 |

### 2. 操作：如何在 Grafana 添加面板？

虽然项目在 [`charge-point-gateway/monitoring/grafana/dashboards/charge-point-gateway.json`](charge-point-gateway/monitoring/grafana/dashboards/charge-point-gateway.json:1) 提供了一个预置的仪表板，但了解如何手动创建和自定义面板对于日常运维和问题排查至关重要。

以下是详细的步骤，我们以创建一个 **“活跃连接数”** 的面板为例。

---

#### **详细操作步骤**

1.  **创建新仪表板或选择现有仪表板**
    *   在 Grafana 左侧菜单中，点击 **Dashboards**。
    *   您可以点击右上角的 **New** → **New Dashboard** 创建一个全新的仪表板。
    *   或者，您可以打开一个现有的仪表板（比如预置的 `charge-point-gateway`）进行编辑。

2.  **添加新面板**
    *   在仪表板页面，点击右上角的 **Add** → **Visualization**。
    *   您会进入一个新的、空白的面板编辑界面。

3.  **配置数据源和查询**
    *   在下方的配置区域，确保 **Data source** 选择的是 `Prometheus`（这应该是默认的）。
    *   在 **Metrics** 浏览器（或查询输入框）中，输入我们要查询的指标。对于“活跃连接数”，我们输入：
        ```promql
        gateway_active_connections
        ```
    *   输入后，可以点击输入框外部或按 `Shift + Enter` 来执行查询，上方图表区域应该会开始显示数据（如果网关正在运行并有连接）。

4.  **选择并调整可视化类型**
    *   在右侧的 **Visualizations** 区域，选择最适合展示数据的图表类型。
    *   对于像“活跃连接数”这样的单个实时数值，**Stat** 或 **Gauge** 是最佳选择。
        *   点击 **Stat**。
    *   对于像“消息速率”这样的时间序列数据，**Time series** 是最佳选择。

5.  **自定义面板选项**
    *   在右侧配置区域，您可以自定义面板的各种显示效果：
        *   **Panel options** -> **Title**: 给您的面板起一个清晰的标题，例如 `活跃WebSocket连接数`。
        *   **Standard options** -> **Unit**: 为数据选择一个单位。对于连接数，可以选择 `Misc / None`。对于延迟，可以选择 `Time / milliseconds`。
        *   **Value options** -> **Fields**: 可以选择显示哪些字段，通常保持默认的 `Numeric fields` 即可。

6.  **应用并保存**
    *   完成所有配置后，点击右上角的 **Apply** 按钮，将此面板应用到仪表板。
    *   您会被带回到仪表板视图，并看到新添加的面板。
    *   最后，不要忘记点击仪表板右上角的 **Save dashboard** 按钮（软盘图标），输入一个名称来保存您的整个仪表板。

---

#### **实践：创建更多面板**

您可以重复以上步骤，使用第一部分表格中提供的 PromQL 查询来创建更多有用的面板：

*   **消息接收速率 (TPS)**:
    *   **查询**: `sum(rate(gateway_messages_received_total[5m]))`
    *   **可视化**: Time series
    *   **标题**: `消息接收速率 (5分钟平均)`
    *   **单位**: `Ops / ops/sec (TPS)`

*   **P95 消息处理延迟**:
    *   **查询**: `histogram_quantile(0.95, sum(rate(gateway_message_processing_duration_seconds_bucket[5m])) by (le)) * 1000` (乘以1000转换为毫秒)
    *   **可视化**: Time series
    *   **标题**: `P95 消息处理延迟`
    *   **单位**: `Time / Milliseconds (ms)`

*   **Kafka 消费延迟**:
    *   **查询**: `kafka_consumergroup_lag{consumergroup="your-consumer-group"}` (请将 `your-consumer-group` 替换为实际的消费组名称)
    *   **可视化**: Time series 或 Stat
    *   **标题**: `Kafka 消费延迟`
    *   **单位**: `Misc / None`

通过组合这些面板，您可以构建一个功能强大的、定制化的监控仪表板，全面掌握充电桩网关的运行状态。