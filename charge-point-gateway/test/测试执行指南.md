# å……ç”µæ¡©ç½‘å…³æµ‹è¯•æ‰§è¡ŒæŒ‡å—

## ï¿½ï¸ æµ‹è¯•å±‚æ¬¡ç»“æ„

```
æµ‹è¯•ç±»å‹
â”œâ”€â”€ å•å…ƒæµ‹è¯• (Unit Tests)
â”‚   â”œâ”€â”€ ç¯å¢ƒ: ä»…éœ€Goç¯å¢ƒ
â”‚   â”œâ”€â”€ èŒƒå›´: å†…éƒ¨æ¨¡å—ã€å·¥å…·å‡½æ•°ã€OCPPæ¶ˆæ¯å¤„ç†
â”‚   â”œâ”€â”€ ç‰¹ç‚¹: å¿«é€Ÿæ‰§è¡Œï¼Œæ— å¤–éƒ¨ä¾èµ–
â”‚   â”œâ”€â”€ æ–‡ä»¶: ./test/*_test.go (TestOCPP*, TestLoad*, TestAssertion*)
â”‚   â””â”€â”€ æ‰§è¡Œ: go test ./test -run "TestOCPP|TestLoad|TestAssertion"
â”‚
â”œâ”€â”€ é›†æˆæµ‹è¯• (Integration Tests)
â”‚   â”œâ”€â”€ ç¯å¢ƒ: ä½¿ç”¨ TestContainers åŠ¨æ€åˆ›å»ºå®¹å™¨
â”‚   â”œâ”€â”€ èŒƒå›´: ä¸Šæ¸¸/ä¸‹æ¸¸æ¶ˆæ¯å¤„ç†ã€é”™è¯¯å¤„ç†ã€æœåŠ¡é›†æˆ
â”‚   â”œâ”€â”€ ç‰¹ç‚¹: éš”ç¦»æ€§å¥½ï¼Œæ¯ä¸ªæµ‹è¯•ç‹¬ç«‹çš„å®¹å™¨ç¯å¢ƒ
â”‚   â”œâ”€â”€ æ–‡ä»¶: ./test/integration/upstream/, ./test/integration/downstream/
â”‚   â”œâ”€â”€ ä¼˜ç‚¹: è‡ªåŠ¨ç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸï¼Œæµ‹è¯•ç¯å¢ƒå¹²å‡€
â”‚   â””â”€â”€ æ‰§è¡Œ: go test ./test/integration/... -timeout 120s
â”‚
â””â”€â”€ E2Eæµ‹è¯• (End-to-End Tests)
    â”œâ”€â”€ ç¯å¢ƒ: ä½¿ç”¨ Docker Compose é¢„å¯åŠ¨çš„å®Œæ•´ç¯å¢ƒ
    â”œâ”€â”€ èŒƒå›´: å®Œæ•´ä¸šåŠ¡æµç¨‹ã€é«˜å¯ç”¨æ€§ã€æ€§èƒ½æµ‹è¯•
    â”œâ”€â”€ ç‰¹ç‚¹: æ¥è¿‘ç”Ÿäº§ç¯å¢ƒï¼Œæµ‹è¯•å®Œæ•´ç³»ç»Ÿäº¤äº’
    â”œâ”€â”€ æ–‡ä»¶: ./test/e2e/business_flow/, ./test/e2e/high_availability/
    â”œâ”€â”€ ä¼˜ç‚¹: çœŸå®ç¯å¢ƒæµ‹è¯•ï¼ŒéªŒè¯ç«¯åˆ°ç«¯åŠŸèƒ½
    â””â”€â”€ æ‰§è¡Œ: éœ€è¦å…ˆå¯åŠ¨ docker-compose -f test/docker-compose.test.yml up -d
```

## ï¿½ğŸ¯ æµ‹è¯•ç±»å‹å’Œæ‰§è¡Œæ–¹æ³•

### 1. å•å…ƒæµ‹è¯• (æœ¬åœ°ç¯å¢ƒ)
```bash
# ä»…è¿è¡Œå•å…ƒæµ‹è¯•ï¼Œæ— éœ€Docker
./test/run_tests.sh --local-only unit

# è¯¦ç»†è¾“å‡º
./test/run_tests.sh -v --local-only unit
```

### 2. é›†æˆæµ‹è¯• (ä½¿ç”¨TestContainers)
```bash
# ä½¿ç”¨æµ‹è¯•è„šæœ¬ (æ¨è)
./test/run_tests.sh integration

# æ‰‹åŠ¨æ–¹å¼ - TestContainersä¼šè‡ªåŠ¨åˆ›å»ºå’Œé”€æ¯å®¹å™¨
go test -v ./test/integration/... -timeout 120s

# æ³¨æ„: é›†æˆæµ‹è¯•ä½¿ç”¨TestContainersï¼Œæ— éœ€é¢„å¯åŠ¨Docker Compose
# TestContainersä¼šè‡ªåŠ¨ç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸ
```

### 3. E2Eæµ‹è¯• (éœ€è¦å®Œæ•´ç¯å¢ƒ)
```bash
# å¯åŠ¨å®Œæ•´ç¯å¢ƒå¹¶è¿è¡ŒE2Eæµ‹è¯•
./test/run_tests.sh e2e

# ä¿æŒç¯å¢ƒè¿è¡Œ
./test/run_tests.sh --keep-env e2e
```

### 4. éªŒè¯ä¿®å¤ (verify_fixes)
```bash
# ç¼–è¯‘å¹¶è¿è¡ŒéªŒè¯å·¥å…· (æ¨è)
go test -c -o test_verify_fixes.exe github.com/charging-platform/charge-point-gateway/test
.\test_verify_fixes.exe

# æ³¨æ„: verify_fixesä¸­çš„æµ‹è¯•å‡½æ•°ä¸æ˜¯æ ‡å‡†Goæµ‹è¯•ï¼Œæ— æ³•é€šè¿‡go test -runæ‰§è¡Œ
# å¿…é¡»ä½¿ç”¨ç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶è¿è¡Œ
```

## ï¿½ æµ‹è¯•æ–‡ä»¶ç»“æ„è¯¦è§£

### å•å…ƒæµ‹è¯•æ–‡ä»¶
```
test/
â”œâ”€â”€ example_test.go              # ç¤ºä¾‹æµ‹è¯•
â”œâ”€â”€ websocket_basic_test.go      # WebSocketåŸºç¡€åŠŸèƒ½æµ‹è¯•
â”œâ”€â”€ websocket_unit_test.go       # WebSocketå•å…ƒæµ‹è¯•
â”œâ”€â”€ verify_fixes.go              # ä¿®å¤éªŒè¯å·¥å…· (åŒ…å«mainå‡½æ•°)
â””â”€â”€ utils/
    â”œâ”€â”€ assertions.go            # æ–­è¨€å·¥å…·å‡½æ•°
    â””â”€â”€ test_helpers.go          # æµ‹è¯•è¾…åŠ©å·¥å…·
```

### é›†æˆæµ‹è¯•æ–‡ä»¶ (TestContainers)
```
test/integration/
â”œâ”€â”€ upstream/                    # ä¸Šæ¸¸æ¶ˆæ¯é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ boot_notification_test.go      # æ¡©ä¸Šçº¿æµç¨‹æµ‹è¯•
â”‚   â”œâ”€â”€ meter_values_test.go           # è®¡é‡æ•°æ®ä¸ŠæŠ¥æµ‹è¯•
â”‚   â””â”€â”€ status_notification_test.go    # çŠ¶æ€é€šçŸ¥æµ‹è¯•
â”œâ”€â”€ downstream/                  # ä¸‹æ¸¸æ¶ˆæ¯é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ remote_start_transaction_test.go  # è¿œç¨‹å¯åŠ¨äº¤æ˜“æµ‹è¯•
â”œâ”€â”€ error_handling/              # é”™è¯¯å¤„ç†é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ dependency_failure_test.go     # ä¾èµ–æœåŠ¡æ•…éšœæµ‹è¯•
â”‚   â””â”€â”€ malformed_messages_test.go     # ç•¸å½¢æ¶ˆæ¯å¤„ç†æµ‹è¯•
â””â”€â”€ websocket_integration_test.go      # WebSocketé›†æˆæµ‹è¯•
```

### E2Eæµ‹è¯•æ–‡ä»¶ (Docker Compose)
```
test/e2e/
â”œâ”€â”€ business_flow/               # ä¸šåŠ¡æµç¨‹ç«¯åˆ°ç«¯æµ‹è¯•
â”‚   â””â”€â”€ complete_charging_session_test.go  # å®Œæ•´å……ç”µä¼šè¯æµ‹è¯•
â”œâ”€â”€ high_availability/           # é«˜å¯ç”¨æ€§æµ‹è¯•
â”‚   â””â”€â”€ failover_test.go                   # æ•…éšœè½¬ç§»æµ‹è¯•
â””â”€â”€ performance/                 # æ€§èƒ½æµ‹è¯•
    â””â”€â”€ concurrent_connections_test.go     # å¹¶å‘è¿æ¥æµ‹è¯•
```

## ï¿½ğŸ”§ æµ‹è¯•è„šæœ¬å‚æ•°

### åŸºæœ¬ç”¨æ³•
```bash
./test/run_tests.sh [é€‰é¡¹] [æµ‹è¯•ç±»å‹]
```

### é€‰é¡¹è¯´æ˜
- `-h, --help` - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
- `-v, --verbose` - è¯¦ç»†è¾“å‡º
- `-c, --clean` - æµ‹è¯•å‰æ¸…ç†ç¯å¢ƒ
- `--no-build` - è·³è¿‡æ„å»ºæ­¥éª¤
- `--keep-env` - æµ‹è¯•åä¿æŒç¯å¢ƒè¿è¡Œ
- `--local-only` - ä»…è¿è¡Œæœ¬åœ°æµ‹è¯•ï¼ˆä¸å¯åŠ¨Dockerï¼‰

### æµ‹è¯•ç±»å‹
- `unit` - å•å…ƒæµ‹è¯•
- `integration` - é›†æˆæµ‹è¯•
- `e2e` - ç«¯åˆ°ç«¯æµ‹è¯•
- `performance` - æ€§èƒ½æµ‹è¯•
- `all` - æ‰€æœ‰æµ‹è¯•ï¼ˆé»˜è®¤ï¼‰

### ç¤ºä¾‹å‘½ä»¤
```bash
# è¯¦ç»†è¾“å‡ºï¼Œæ¸…ç†ç¯å¢ƒï¼Œè¿è¡ŒE2Eæµ‹è¯•
./test/run_tests.sh -v -c e2e

# ä»…è¿è¡Œæœ¬åœ°å•å…ƒæµ‹è¯•
./test/run_tests.sh --local-only unit

# è·³è¿‡æ„å»ºï¼Œä¿æŒç¯å¢ƒï¼Œè¿è¡Œæ‰€æœ‰æµ‹è¯•
./test/run_tests.sh --no-build --keep-env all
```

## ğŸ³ Dockerç¯å¢ƒç®¡ç†

### å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
```bash
# å¯åŠ¨åŸºç¡€æœåŠ¡ (Redis + Kafka)
docker-compose -f test/docker-compose.test.yml up -d redis-test zookeeper-test kafka-test

# å¯åŠ¨å®Œæ•´ç¯å¢ƒ (åŒ…æ‹¬ç½‘å…³)
docker-compose -f test/docker-compose.test.yml up -d
```

### æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
docker-compose -f test/docker-compose.test.yml ps

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose -f test/docker-compose.test.yml logs kafka-test
docker-compose -f test/docker-compose.test.yml logs redis-test

# æµ‹è¯•æœåŠ¡è¿æ¥
docker-compose -f test/docker-compose.test.yml exec redis-test redis-cli ping
docker-compose -f test/docker-compose.test.yml exec kafka-test kafka-topics --bootstrap-server kafka-test:9092 --list
```

### åœæ­¢ç¯å¢ƒ
```bash
# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose -f test/docker-compose.test.yml down

# åœæ­¢å¹¶åˆ é™¤æ•°æ®å·
docker-compose -f test/docker-compose.test.yml down -v
```

## ğŸ” å…·ä½“æµ‹è¯•æ–‡ä»¶

### é›†æˆæµ‹è¯•
```bash
# ä¸Šæ¸¸æ¶ˆæ¯æµ‹è¯•
go test -v ./test/integration/upstream/boot_notification_test.go
go test -v ./test/integration/upstream/meter_values_test.go
go test -v ./test/integration/upstream/status_notification_test.go

# ä¸‹æ¸¸æ¶ˆæ¯æµ‹è¯•
go test -v ./test/integration/downstream/remote_start_transaction_test.go

# é”™è¯¯å¤„ç†æµ‹è¯•
go test -v ./test/integration/error_handling/dependency_failure_test.go
go test -v ./test/integration/error_handling/malformed_messages_test.go
```

### E2Eæµ‹è¯•
```bash
# ä¸šåŠ¡æµç¨‹æµ‹è¯•
go test -v ./test/e2e/business_flow/complete_charging_session_test.go

# é«˜å¯ç”¨æ€§æµ‹è¯•
go test -v ./test/e2e/high_availability/failover_test.go

# æ€§èƒ½æµ‹è¯•
go test -v ./test/e2e/performance/concurrent_connections_test.go
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

#### 1. **é›†æˆæµ‹è¯•Kafkaé…ç½®é—®é¢˜** âŒ
```
Error: KAFKA_PROCESS_ROLES is required
```
**åŸå› **: TestContainersä¸­çš„Kafkaå®¹å™¨é…ç½®é—®é¢˜
**è§£å†³æ–¹æ¡ˆ**:
- æš‚æ—¶è·³è¿‡é›†æˆæµ‹è¯•ï¼Œæˆ–
- ä½¿ç”¨ç°æœ‰Docker Composeç¯å¢ƒ: `export USE_TESTCONTAINERS=false`

#### 2. **verify_fixesæµ‹è¯•å‡½æ•°æ— æ³•è¿è¡Œ** âŒ
```
go test -run "TestLocalMode" # æ— æ³•æ‰¾åˆ°æµ‹è¯•
```
**åŸå› **: verify_fixes.goä¸­çš„å‡½æ•°ä¸æ˜¯æ ‡å‡†Goæµ‹è¯•å‡½æ•°
**è§£å†³æ–¹æ¡ˆ**: å¿…é¡»ç¼–è¯‘åè¿è¡Œ
```bash
go test -c -o test_verify_fixes.exe github.com/charging-platform/charge-point-gateway/test
.\test_verify_fixes.exe
```

#### 3. **ç«¯å£å†²çª** âš ï¸
**é—®é¢˜**: ç«¯å£6380, 9093, 8081è¢«å ç”¨
**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥å¹¶åœæ­¢å†²çªæœåŠ¡

### æ£€æŸ¥ç«¯å£å ç”¨ (Windows)
```cmd
netstat -ano | findstr :6380
netstat -ano | findstr :9093
netstat -ano | findstr :8081
```

### ç¯å¢ƒå˜é‡è®¾ç½®
```bash
# Windows PowerShell
$env:DOCKER_ENV="true"    # Dockerç¯å¢ƒ
$env:DOCKER_ENV="false"   # æœ¬åœ°ç¯å¢ƒ

# Windows CMD
set DOCKER_ENV=true       # Dockerç¯å¢ƒ
set DOCKER_ENV=false      # æœ¬åœ°ç¯å¢ƒ

# Linux/Mac
export DOCKER_ENV=true    # Dockerç¯å¢ƒ
export DOCKER_ENV=false   # æœ¬åœ°ç¯å¢ƒ
```

## ğŸ“Š æµ‹è¯•çŠ¶æ€

### âœ… å·²éªŒè¯å¯è¿è¡Œçš„æµ‹è¯•
```bash
# å•å…ƒæµ‹è¯• (å·²æˆåŠŸè¿è¡Œ)
go test -v ./test -run "TestOCPPMessageCreation"           # âœ… PASS
go test -v ./test -run "TestLoadTestData"                  # âœ… PASS
go test -v ./test -run "TestAssertionHelpers"              # âœ… PASS
go test -v ./test -run "TestWebSocketClientCreation"       # âœ… PASS
```

### ğŸ”§ éœ€è¦ç¯å¢ƒçš„æµ‹è¯•
- **é›†æˆæµ‹è¯•**: ä½¿ç”¨TestContainers (è‡ªåŠ¨ç®¡ç†å®¹å™¨)
- **E2Eæµ‹è¯•**: ä½¿ç”¨Docker Composeç¯å¢ƒ (éœ€è¦é¢„å¯åŠ¨)

### ğŸ“‹ æµ‹è¯•è¦†ç›–èŒƒå›´
- **TC-INT-01**: BootNotificationéªŒè¯æ¡©ä¸Šçº¿æµç¨‹ (é›†æˆæµ‹è¯•)
- **TC-INT-02**: MeterValueséªŒè¯è®¡é‡æ•°æ®ä¸ŠæŠ¥ (é›†æˆæµ‹è¯•)
- **TC-E2E-01**: èŠ‚ç‚¹æ•…éšœè½¬ç§» (E2Eæµ‹è¯•)
- **TC-E2E-03**: å®Œæ•´å……ç”µæµç¨‹ (E2Eæµ‹è¯•)

## ğŸ¯ æµ‹è¯•ç­–ç•¥å’Œæœ€ä½³å®è·µ

### å¼€å‘é˜¶æ®µæµ‹è¯•æµç¨‹
```bash
# 1. å¿«é€ŸéªŒè¯ - è¿è¡Œå•å…ƒæµ‹è¯• (< 10ç§’)
go test -v ./test -run "TestOCPP|TestLoad|TestAssertion"

# 2. åŠŸèƒ½éªŒè¯ - è¿è¡Œç›¸å…³é›†æˆæµ‹è¯• (1-3åˆ†é’Ÿ)
go test -v ./test/integration/upstream/boot_notification_test.go

# 3. å®Œæ•´éªŒè¯ - è¿è¡ŒE2Eæµ‹è¯• (5-10åˆ†é’Ÿ)
docker-compose -f test/docker-compose.test.yml up -d
go test -v ./test/e2e/business_flow/complete_charging_session_test.go
```

### æµ‹è¯•ç¯å¢ƒé€‰æ‹©æŒ‡å—
- **å¼€å‘è°ƒè¯•**: å•å…ƒæµ‹è¯• + éƒ¨åˆ†é›†æˆæµ‹è¯•
- **åŠŸèƒ½éªŒè¯**: é›†æˆæµ‹è¯• (TestContainers)
- **å‘å¸ƒå‰éªŒè¯**: E2Eæµ‹è¯• (Docker Compose)
- **CI/CDæµæ°´çº¿**: å…¨éƒ¨æµ‹è¯•ç±»å‹

### æµ‹è¯•éš”ç¦»åŸåˆ™
- **å•å…ƒæµ‹è¯•**: æ— å¤–éƒ¨ä¾èµ–ï¼Œå¯å¹¶è¡Œæ‰§è¡Œ
- **é›†æˆæµ‹è¯•**: TestContainersæä¾›éš”ç¦»ç¯å¢ƒ
- **E2Eæµ‹è¯•**: å…±äº«Docker Composeç¯å¢ƒï¼Œé¡ºåºæ‰§è¡Œ

## âš ï¸ é‡è¦æ¾„æ¸…

### é›†æˆæµ‹è¯• vs E2Eæµ‹è¯•çš„ç¯å¢ƒåŒºåˆ«
```
é›†æˆæµ‹è¯• (Integration Tests):
â”œâ”€â”€ ç¯å¢ƒ: TestContainers (åŠ¨æ€åˆ›å»º)
â”œâ”€â”€ ä¼˜ç‚¹: æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹ç¯å¢ƒï¼Œè‡ªåŠ¨æ¸…ç†
â”œâ”€â”€ ç¼ºç‚¹: å¯åŠ¨è¾ƒæ…¢ï¼Œå¯èƒ½æœ‰é…ç½®é—®é¢˜
â””â”€â”€ æ‰§è¡Œ: go test ./test/integration/...

E2Eæµ‹è¯• (End-to-End Tests):
â”œâ”€â”€ ç¯å¢ƒ: Docker Compose (é¢„å¯åŠ¨)
â”œâ”€â”€ ä¼˜ç‚¹: ç¨³å®šç¯å¢ƒï¼Œæ¥è¿‘ç”Ÿäº§
â”œâ”€â”€ ç¼ºç‚¹: éœ€è¦æ‰‹åŠ¨ç®¡ç†ç¯å¢ƒ
â””â”€â”€ æ‰§è¡Œ: å…ˆå¯åŠ¨ç¯å¢ƒï¼Œå†è¿è¡Œæµ‹è¯•
```

### å½“å‰å·²çŸ¥é™åˆ¶
- **é›†æˆæµ‹è¯•**: Kafkaé…ç½®é—®é¢˜å¯¼è‡´éƒ¨åˆ†æµ‹è¯•å¤±è´¥
- **verify_fixes**: ç‰¹æ®Šçš„æµ‹è¯•å·¥å…·ï¼Œéœ€è¦ç¼–è¯‘è¿è¡Œ
- **å•å…ƒæµ‹è¯•**: å®Œå…¨å¯ç”¨ï¼Œæ¨èæ—¥å¸¸å¼€å‘ä½¿ç”¨
