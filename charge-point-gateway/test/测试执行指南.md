# 充电桩网关测试执行指南

## �️ 测试层次结构

```
测试类型
├── 单元测试 (Unit Tests)
│   ├── 环境: 仅需Go环境
│   ├── 范围: 内部模块、工具函数、OCPP消息处理
│   ├── 特点: 快速执行，无外部依赖
│   ├── 文件: ./test/*_test.go (TestOCPP*, TestLoad*, TestAssertion*)
│   └── 执行: go test ./test -run "TestOCPP|TestLoad|TestAssertion"
│
├── 集成测试 (Integration Tests)
│   ├── 环境: 使用 TestContainers 动态创建容器
│   ├── 范围: 上游/下游消息处理、错误处理、服务集成
│   ├── 特点: 隔离性好，每个测试独立的容器环境
│   ├── 文件: ./test/integration/upstream/, ./test/integration/downstream/
│   ├── 优点: 自动管理容器生命周期，测试环境干净
│   └── 执行: go test ./test/integration/... -timeout 120s
│
└── E2E测试 (End-to-End Tests)
    ├── 环境: 使用 Docker Compose 预启动的完整环境
    ├── 范围: 完整业务流程、高可用性、性能测试
    ├── 特点: 接近生产环境，测试完整系统交互
    ├── 文件: ./test/e2e/business_flow/, ./test/e2e/high_availability/
    ├── 优点: 真实环境测试，验证端到端功能
    └── 执行: 需要先启动 docker-compose -f test/docker-compose.test.yml up -d
```

## �🎯 测试类型和执行方法

### 1. 单元测试 (本地环境)
```bash
# 仅运行单元测试，无需Docker
./test/run_tests.sh --local-only unit

# 详细输出
./test/run_tests.sh -v --local-only unit
```

### 2. 集成测试 (使用TestContainers)
```bash
# 使用测试脚本 (推荐)
./test/run_tests.sh integration

# 手动方式 - TestContainers会自动创建和销毁容器
go test -v ./test/integration/... -timeout 120s

# 注意: 集成测试使用TestContainers，无需预启动Docker Compose
# TestContainers会自动管理容器生命周期
```

### 3. E2E测试 (需要完整环境)
```bash
# 启动完整环境并运行E2E测试
./test/run_tests.sh e2e

# 保持环境运行
./test/run_tests.sh --keep-env e2e
```

### 4. 验证修复 (verify_fixes)
```bash
# 编译并运行验证工具 (推荐)
go test -c -o test_verify_fixes.exe github.com/charging-platform/charge-point-gateway/test
.\test_verify_fixes.exe

# 注意: verify_fixes中的测试函数不是标准Go测试，无法通过go test -run执行
# 必须使用编译后的可执行文件运行
```

## � 测试文件结构详解

### 单元测试文件
```
test/
├── example_test.go              # 示例测试
├── websocket_basic_test.go      # WebSocket基础功能测试
├── websocket_unit_test.go       # WebSocket单元测试
├── verify_fixes.go              # 修复验证工具 (包含main函数)
└── utils/
    ├── assertions.go            # 断言工具函数
    └── test_helpers.go          # 测试辅助工具
```

### 集成测试文件 (TestContainers)
```
test/integration/
├── upstream/                    # 上游消息集成测试
│   ├── boot_notification_test.go      # 桩上线流程测试
│   ├── meter_values_test.go           # 计量数据上报测试
│   └── status_notification_test.go    # 状态通知测试
├── downstream/                  # 下游消息集成测试
│   └── remote_start_transaction_test.go  # 远程启动交易测试
├── error_handling/              # 错误处理集成测试
│   ├── dependency_failure_test.go     # 依赖服务故障测试
│   └── malformed_messages_test.go     # 畸形消息处理测试
└── websocket_integration_test.go      # WebSocket集成测试
```

### E2E测试文件 (Docker Compose)
```
test/e2e/
├── business_flow/               # 业务流程端到端测试
│   └── complete_charging_session_test.go  # 完整充电会话测试
├── high_availability/           # 高可用性测试
│   └── failover_test.go                   # 故障转移测试
└── performance/                 # 性能测试
    └── concurrent_connections_test.go     # 并发连接测试
```

## �🔧 测试脚本参数

### 基本用法
```bash
./test/run_tests.sh [选项] [测试类型]
```

### 选项说明
- `-h, --help` - 显示帮助信息
- `-v, --verbose` - 详细输出
- `-c, --clean` - 测试前清理环境
- `--no-build` - 跳过构建步骤
- `--keep-env` - 测试后保持环境运行
- `--local-only` - 仅运行本地测试（不启动Docker）

### 测试类型
- `unit` - 单元测试
- `integration` - 集成测试
- `e2e` - 端到端测试
- `performance` - 性能测试
- `all` - 所有测试（默认）

### 示例命令
```bash
# 详细输出，清理环境，运行E2E测试
./test/run_tests.sh -v -c e2e

# 仅运行本地单元测试
./test/run_tests.sh --local-only unit

# 跳过构建，保持环境，运行所有测试
./test/run_tests.sh --no-build --keep-env all
```

## 🐳 Docker环境管理

### 启动测试环境
```bash
# 启动基础服务 (Redis + Kafka)
docker-compose -f test/docker-compose.test.yml up -d redis-test zookeeper-test kafka-test

# 启动完整环境 (包括网关)
docker-compose -f test/docker-compose.test.yml up -d
```

### 检查服务状态
```bash
# 查看所有服务状态
docker-compose -f test/docker-compose.test.yml ps

# 查看服务日志
docker-compose -f test/docker-compose.test.yml logs kafka-test
docker-compose -f test/docker-compose.test.yml logs redis-test

# 测试服务连接
docker-compose -f test/docker-compose.test.yml exec redis-test redis-cli ping
docker-compose -f test/docker-compose.test.yml exec kafka-test kafka-topics --bootstrap-server kafka-test:9092 --list
```

### 停止环境
```bash
# 停止所有服务
docker-compose -f test/docker-compose.test.yml down

# 停止并删除数据卷
docker-compose -f test/docker-compose.test.yml down -v
```

## 🔍 具体测试文件

### 集成测试
```bash
# 上游消息测试
go test -v ./test/integration/upstream/boot_notification_test.go
go test -v ./test/integration/upstream/meter_values_test.go
go test -v ./test/integration/upstream/status_notification_test.go

# 下游消息测试
go test -v ./test/integration/downstream/remote_start_transaction_test.go

# 错误处理测试
go test -v ./test/integration/error_handling/dependency_failure_test.go
go test -v ./test/integration/error_handling/malformed_messages_test.go
```

### E2E测试
```bash
# 业务流程测试
go test -v ./test/e2e/business_flow/complete_charging_session_test.go

# 高可用性测试
go test -v ./test/e2e/high_availability/failover_test.go

# 性能测试
go test -v ./test/e2e/performance/concurrent_connections_test.go
```

## 🚨 故障排除

### 常见问题和解决方案

#### 1. **集成测试Kafka配置问题** ❌
```
Error: KAFKA_PROCESS_ROLES is required
```
**原因**: TestContainers中的Kafka容器配置问题
**解决方案**:
- 暂时跳过集成测试，或
- 使用现有Docker Compose环境: `export USE_TESTCONTAINERS=false`

#### 2. **verify_fixes测试函数无法运行** ❌
```
go test -run "TestLocalMode" # 无法找到测试
```
**原因**: verify_fixes.go中的函数不是标准Go测试函数
**解决方案**: 必须编译后运行
```bash
go test -c -o test_verify_fixes.exe github.com/charging-platform/charge-point-gateway/test
.\test_verify_fixes.exe
```

#### 3. **端口冲突** ⚠️
**问题**: 端口6380, 9093, 8081被占用
**解决方案**: 检查并停止冲突服务

### 检查端口占用 (Windows)
```cmd
netstat -ano | findstr :6380
netstat -ano | findstr :9093
netstat -ano | findstr :8081
```

### 环境变量设置
```bash
# Windows PowerShell
$env:DOCKER_ENV="true"    # Docker环境
$env:DOCKER_ENV="false"   # 本地环境

# Windows CMD
set DOCKER_ENV=true       # Docker环境
set DOCKER_ENV=false      # 本地环境

# Linux/Mac
export DOCKER_ENV=true    # Docker环境
export DOCKER_ENV=false   # 本地环境
```

## 📊 测试状态

### ✅ 已验证可运行的测试
```bash
# 单元测试 (已成功运行)
go test -v ./test -run "TestOCPPMessageCreation"           # ✅ PASS
go test -v ./test -run "TestLoadTestData"                  # ✅ PASS
go test -v ./test -run "TestAssertionHelpers"              # ✅ PASS
go test -v ./test -run "TestWebSocketClientCreation"       # ✅ PASS
```

### 🔧 需要环境的测试
- **集成测试**: 使用TestContainers (自动管理容器)
- **E2E测试**: 使用Docker Compose环境 (需要预启动)

### 📋 测试覆盖范围
- **TC-INT-01**: BootNotification验证桩上线流程 (集成测试)
- **TC-INT-02**: MeterValues验证计量数据上报 (集成测试)
- **TC-E2E-01**: 节点故障转移 (E2E测试)
- **TC-E2E-03**: 完整充电流程 (E2E测试)

## 🎯 测试策略和最佳实践

### 开发阶段测试流程
```bash
# 1. 快速验证 - 运行单元测试 (< 10秒)
go test -v ./test -run "TestOCPP|TestLoad|TestAssertion"

# 2. 功能验证 - 运行相关集成测试 (1-3分钟)
go test -v ./test/integration/upstream/boot_notification_test.go

# 3. 完整验证 - 运行E2E测试 (5-10分钟)
docker-compose -f test/docker-compose.test.yml up -d
go test -v ./test/e2e/business_flow/complete_charging_session_test.go
```

### 测试环境选择指南
- **开发调试**: 单元测试 + 部分集成测试
- **功能验证**: 集成测试 (TestContainers)
- **发布前验证**: E2E测试 (Docker Compose)
- **CI/CD流水线**: 全部测试类型

### 测试隔离原则
- **单元测试**: 无外部依赖，可并行执行
- **集成测试**: TestContainers提供隔离环境
- **E2E测试**: 共享Docker Compose环境，顺序执行

## ⚠️ 重要澄清

### 集成测试 vs E2E测试的环境区别
```
集成测试 (Integration Tests):
├── 环境: TestContainers (动态创建)
├── 优点: 每个测试独立环境，自动清理
├── 缺点: 启动较慢，可能有配置问题
└── 执行: go test ./test/integration/...

E2E测试 (End-to-End Tests):
├── 环境: Docker Compose (预启动)
├── 优点: 稳定环境，接近生产
├── 缺点: 需要手动管理环境
└── 执行: 先启动环境，再运行测试
```

### 当前已知限制
- **集成测试**: Kafka配置问题导致部分测试失败
- **verify_fixes**: 特殊的测试工具，需要编译运行
- **单元测试**: 完全可用，推荐日常开发使用
