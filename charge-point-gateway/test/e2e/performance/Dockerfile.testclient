# 使用与主应用一致的基础镜像
FROM golang:1.23-alpine

# 设置工作目录
WORKDIR /app

# 复制go.mod和go.sum并下载依赖
COPY ../../../go.mod ../../../go.sum ./
# 设置国内Go代理以加速下载
ENV GOPROXY=https://goproxy.cn,direct
RUN go mod download

# 复制整个项目代码
COPY ../../../ .

# 构建测试可执行文件
# -c: 编译但不运行
# -o: 指定输出文件
RUN go test -c -o /app/performance.test github.com/charging-platform/charge-point-gateway/test/e2e/performance

# 设置默认环境变量（分布式测试支持）
ENV CONNECTION_COUNT=10000
ENV CLIENT_ID=single
ENV ID_OFFSET=0
ENV GATEWAY_URL=ws://gateway-test:8080/ocpp
ENV REDIS_ADDR=redis-test:6379
ENV KAFKA_BROKERS=kafka-test:9092

# 最终的运行命令
CMD ["/app/performance.test", "-test.v", "-test.run", "TestTC_E2E_04_ConcurrentConnections"]